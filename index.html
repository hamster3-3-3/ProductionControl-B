<!DOCTYPE html>
<html lang="zh-Hant"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>製管會項目填寫表單 (含PPT下載)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 PptxGenJS 用於生成簡報 -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- 引入 SheetJS（XLSX）用於 Excel 匯入 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* 淺灰背景 */
        }
        /* 統一輸入框的視覺風格 */
        .form-input {
            /* 保持 w-full 佔滿父容器寬度 */
            @apply w-full border border-gray-300 rounded-lg p-3
                   focus:ring-2 focus:ring-teal-500 focus:border-teal-500
                   transition duration-150;
        }
        /* 隱藏但保持佈局空間的樣式 */
        .hidden-collapse { display: none; }
        /* 用於複製的模板表單，隱藏不顯示 */
        .form-template { display: none; }
        /* 分頁顯示：一次只顯示一筆表單 */
        .form-page { display: none; }
        .form-page.is-active { display: block; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf',
                            500: '#14b8a6', 600: '#0d9488', 700: '#047876', 800: '#065f60', 900: '#004d40',
                        },
                        indigo: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8',
                            500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81',
                        },
                        red: { 100: '#fee2e2', 700: '#b91c1c', 200: '#fecaca', 400: '#f87171' },
                        orange: { 500: '#f97316', 600: '#ea580c', 700: '#c2410c' }
                    }
                }
            }
        }
    </script>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.sticky{position:sticky}.inset-0{inset:0px}.inset-y-0{top:0px;bottom:0px}.left-0{left:0px}.left-4{left:1rem}.top-4{top:1rem}.top-8{top:2rem}.z-40{z-index:40}.z-50{z-index:50}.mx-6{margin-left:1.5rem;margin-right:1.5rem}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-2{margin-left:0.5rem}.mr-3{margin-right:0.75rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.h-2{height:0.5rem}.h-32{height:8rem}.h-36{height:9rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.max-h-64{max-height:16rem}.max-h-\[85vh\]{max-height:85vh}.w-2{width:0.5rem}.w-5{width:1.25rem}.w-72{width:18rem}.w-80{width:20rem}.w-full{width:100%}.max-w-7xl{max-width:80rem}.max-w-\[85vw\]{max-width:85vw}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.-translate-x-full{--tw-translate-x:-100%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.resize-y{resize:vertical}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-6{gap:1.5rem}.space-x-4 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.divide-y > :not([hidden]) ~ :not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.divide-gray-200 > :not([hidden]) ~ :not([hidden]){--tw-divide-opacity:1;border-color:rgb(229 231 235 / var(--tw-divide-opacity, 1))}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-sm{border-radius:0.125rem}.rounded-xl{border-radius:0.75rem}.rounded-b-xl{border-bottom-right-radius:0.75rem;border-bottom-left-radius:0.75rem}.rounded-t-xl{border-top-left-radius:0.75rem;border-top-right-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-l-4{border-left-width:4px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-indigo-200{--tw-border-opacity:1;border-color:rgb(199 210 254 / var(--tw-border-opacity, 1))}.border-indigo-500{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.border-teal-100{--tw-border-opacity:1;border-color:rgb(204 251 241 / var(--tw-border-opacity, 1))}.border-teal-200{--tw-border-opacity:1;border-color:rgb(153 246 228 / var(--tw-border-opacity, 1))}.border-teal-500{--tw-border-opacity:1;border-color:rgb(20 184 166 / var(--tw-border-opacity, 1))}.bg-black\/40{background-color:rgb(0 0 0 / 0.4)}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.bg-indigo-50\/50{background-color:rgb(238 242 255 / 0.5)}.bg-indigo-500{--tw-bg-opacity:1;background-color:rgb(99 102 241 / var(--tw-bg-opacity, 1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.bg-orange-600{--tw-bg-opacity:1;background-color:rgb(234 88 12 / var(--tw-bg-opacity, 1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.bg-slate-900{--tw-bg-opacity:1;background-color:rgb(15 23 42 / var(--tw-bg-opacity, 1))}.bg-teal-50\/50{background-color:rgb(240 253 250 / 0.5)}.bg-teal-500{--tw-bg-opacity:1;background-color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.bg-teal-600{--tw-bg-opacity:1;background-color:rgb(13 148 136 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.object-contain{object-fit:contain}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-2{padding:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-2\.5{padding-top:0.625rem;padding-bottom:0.625rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pb-2{padding-bottom:0.5rem}.pt-16{padding-top:4rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-semibold{font-weight:600}.font-medium{font-weight:500}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-green-300{--tw-text-opacity:1;color:rgb(134 239 172 / var(--tw-text-opacity, 1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61 / var(--tw-text-opacity, 1))}.text-indigo-700{--tw-text-opacity:1;color:rgb(67 56 202 / var(--tw-text-opacity, 1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28 / var(--tw-text-opacity, 1))}.text-teal-600{--tw-text-opacity:1;color:rgb(13 148 136 / var(--tw-text-opacity, 1))}.text-teal-700{--tw-text-opacity:1;color:rgb(4 120 118 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-200{transition-duration:200ms}.duration-300{transition-duration:300ms}.duration-150{transition-duration:150ms}.file\:mr-4::file-selector-button{margin-right:1rem}.file\:rounded-lg::file-selector-button{border-radius:0.5rem}.file\:border-0::file-selector-button{border-width:0px}.file\:bg-teal-50::file-selector-button{--tw-bg-opacity:1;background-color:rgb(240 253 250 / var(--tw-bg-opacity, 1))}.file\:px-4::file-selector-button{padding-left:1rem;padding-right:1rem}.file\:py-2::file-selector-button{padding-top:0.5rem;padding-bottom:0.5rem}.file\:text-sm::file-selector-button{font-size:0.875rem;line-height:1.25rem}.file\:font-semibold::file-selector-button{font-weight:600}.file\:text-teal-700::file-selector-button{--tw-text-opacity:1;color:rgb(4 120 118 / var(--tw-text-opacity, 1))}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.hover\:bg-indigo-700:hover{--tw-bg-opacity:1;background-color:rgb(67 56 202 / var(--tw-bg-opacity, 1))}.hover\:bg-orange-700:hover{--tw-bg-opacity:1;background-color:rgb(194 65 12 / var(--tw-bg-opacity, 1))}.hover\:bg-red-200:hover{--tw-bg-opacity:1;background-color:rgb(254 202 202 / var(--tw-bg-opacity, 1))}.hover\:bg-slate-800:hover{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.hover\:bg-teal-50:hover{--tw-bg-opacity:1;background-color:rgb(240 253 250 / var(--tw-bg-opacity, 1))}.hover\:bg-teal-700:hover{--tw-bg-opacity:1;background-color:rgb(4 120 118 / var(--tw-bg-opacity, 1))}.hover\:text-teal-700:hover{--tw-text-opacity:1;color:rgb(4 120 118 / var(--tw-text-opacity, 1))}.hover\:file\:bg-teal-100::file-selector-button:hover{--tw-bg-opacity:1;background-color:rgb(204 251 241 / var(--tw-bg-opacity, 1))}.focus\:border-indigo-500:focus{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.focus\:border-teal-500:focus{--tw-border-opacity:1;border-color:rgb(20 184 166 / var(--tw-border-opacity, 1))}.focus\:ring-4:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-indigo-300:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(165 180 252 / var(--tw-ring-opacity, 1))}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241 / var(--tw-ring-opacity, 1))}.focus\:ring-orange-300:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(253 186 116 / var(--tw-ring-opacity, 1))}.focus\:ring-red-400:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(248 113 113 / var(--tw-ring-opacity, 1))}.focus\:ring-slate-200:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(226 232 240 / var(--tw-ring-opacity, 1))}.focus\:ring-teal-200:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(153 246 228 / var(--tw-ring-opacity, 1))}.focus\:ring-teal-300:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(94 234 212 / var(--tw-ring-opacity, 1))}.focus\:ring-teal-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(20 184 166 / var(--tw-ring-opacity, 1))}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:opacity-40:disabled{opacity:0.4}@media (min-width: 768px){.md\:h-36{height:9rem}.md\:h-40{height:10rem}.md\:w-auto{width:auto}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:flex-row{flex-direction:row}.md\:items-center{align-items:center}.md\:justify-between{justify-content:space-between}.md\:space-x-6 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1.5rem * var(--tw-space-x-reverse));margin-left:calc(1.5rem * calc(1 - var(--tw-space-x-reverse)))}.md\:space-y-0 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0px * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0px * var(--tw-space-y-reverse))}.md\:p-8{padding:2rem}}@media (min-width: 1024px){.lg\:block{display:block}.lg\:hidden{display:none}.lg\:flex-row{flex-direction:row}.lg\:pt-0{padding-top:0px}}</style></head>

<body class="p-4 md:p-8">

    <!-- ============ Mobile: 左上角「試產目錄」按鈕 + 抽屜式目錄（避免蓋住表單） ============ -->
    <div class="lg:hidden fixed top-4 left-4 z-50">
        <button type="button" id="mobile-toc-open-btn" class="flex items-center gap-2 px-4 py-2 bg-white text-teal-700 font-semibold rounded-xl shadow-lg border border-gray-200 hover:bg-teal-50 focus:ring-4 focus:ring-teal-200">
            <span class="inline-block w-2 h-2 rounded-full bg-teal-500"></span>
            試產目錄
        </button>
    </div>

    <!-- 背景遮罩 -->
    <div id="mobile-toc-backdrop" class="hidden lg:hidden fixed inset-0 z-40 bg-black/40"></div>

    <!-- 左側抽屜 -->
    <aside id="mobile-toc-drawer" class="lg:hidden fixed inset-y-0 left-0 z-50 w-80 max-w-[85vw] bg-white shadow-2xl border-r border-gray-200 transform -translate-x-full transition-transform duration-200 flex flex-col">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
            <h2 class="text-lg font-extrabold text-teal-700">試產目錄</h2>
            <button type="button" id="mobile-toc-close-btn" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold">
                關閉
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <div id="toc-container-mobile" class="space-y-2"><a href="#tracking-form-instance-1" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="香草可樂風味雲餡泡芙">香草可樂風味雲餡泡芙</a><a href="#tracking-form-instance-2" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="起司舒芙蕾布丁(舊檔重開)">起司舒芙蕾布丁</a><a href="#tracking-form-instance-3" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="香菜蝦蝦捲">香菜蝦蝦捲</a><a href="#tracking-form-instance-4" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="冰烤地瓜沙拉">冰烤地瓜沙拉</a><a href="#tracking-form-instance-5" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="溏心蛋洋芋沙拉">溏心蛋洋芋沙拉</a><a href="#tracking-form-instance-6" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="黃金地瓜菜菜捲">黃金地瓜菜菜捲</a></div>
        </div>
    </aside>

    <!-- Responsive Wrapper -->
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6 pt-16 lg:pt-0">

        <!-- Desktop: Sidebar -->
        <div class="hidden lg:block w-72 flex-shrink-0">
            <div class="sticky top-8 p-4 bg-white rounded-xl shadow-xl border border-gray-200 max-h-[85vh] overflow-y-auto">
                <h2 class="text-xl font-bold text-teal-600 border-b-2 border-teal-100 pb-2 mb-3">試產目錄</h2>
                <div id="toc-container-desktop" class="space-y-2"><a href="#tracking-form-instance-1" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="香草可樂風味雲餡泡芙">香草可樂風味雲餡泡芙</a><a href="#tracking-form-instance-2" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="起司舒芙蕾布丁(舊檔重開)">起司舒芙蕾布丁</a><a href="#tracking-form-instance-3" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="香菜蝦蝦捲">香菜蝦蝦捲</a><a href="#tracking-form-instance-4" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="冰烤地瓜沙拉">冰烤地瓜沙拉</a><a href="#tracking-form-instance-5" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="溏心蛋洋芋沙拉">溏心蛋洋芋沙拉</a><a href="#tracking-form-instance-6" class="block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate" title="黃金地瓜菜菜捲">黃金地瓜菜菜捲</a></div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="flex-grow">
            <div id="main-container" class="bg-white rounded-xl shadow-2xl">
                <div class="p-6 rounded-t-xl bg-gray-50 border-b border-gray-200">
                    <h1 class="text-3xl font-extrabold text-gray-800">製管會項目</h1>
                    <p class="text-gray-500 mt-1">請填寫試產相關資訊及異常/優化追蹤細節。<span class="font-semibold">所有欄位皆為非必填</span></p>

                    <!-- 分頁導覽（一次顯示一筆表單） -->
                    <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex items-center gap-2">
                            <button type="button" id="prev-form-btn" class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-semibold shadow-sm hover:bg-gray-50 focus:ring-4 focus:ring-teal-200 disabled:opacity-40 disabled:cursor-not-allowed" disabled="">
                                上一筆
                            </button>
                            <button type="button" id="next-form-btn" class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-semibold shadow-sm hover:bg-gray-50 focus:ring-4 focus:ring-teal-200 disabled:opacity-40 disabled:cursor-not-allowed">
                                下一筆
                            </button>
                            <span id="pager-indicator" class="ml-2 text-sm text-gray-500">目前：1 / 6</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            透過左側「試產目錄」點擊項目即可直接切換到該筆表單。
                        </div>
                    </div>

                    <!-- ===== 匯入表格區塊（新增） ===== -->
                    
                    <!-- ===== 匯入表格區塊（新增）End ===== -->

                </div>

                <div id="forms-wrapper" class="divide-y divide-gray-200"></div>

                <!-- Master Action Buttons -->
                <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-6 p-6 bg-gray-50 rounded-b-xl border-t border-gray-200">
                    <button type="button" id="submit-all-btn" class="w-full md:w-auto px-8 py-3 bg-teal-600 text-white font-bold rounded-xl shadow-lg hover:bg-teal-700
                                    transition duration-300 transform hover:scale-105 focus:ring-4 focus:ring-teal-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        上傳報表
                    </button>

                    <button type="button" id="download-ppt-btn" class="w-full md:w-auto px-8 py-3 bg-orange-600 text-white font-bold rounded-xl shadow-lg hover:bg-orange-700
                                    transition duration-300 transform hover:scale-105 focus:ring-4 focus:ring-orange-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        下載簡報 (PPTX)
                    </button>
                </div>

                <!-- 輸出結果區塊 -->
                <div id="output-section" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2 px-6">CSV/Excel 輸出內容 (共 <span id="form-count-output">0</span> 筆)</h2>
                    <pre id="form-output" class="bg-gray-800 text-green-300 p-6 rounded-xl shadow-inner overflow-x-auto text-sm mx-6"></pre>
                    <p class="text-xs text-gray-500 mt-2 px-6">CSV 已上傳至 Google 雲端硬碟。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 表單模板 -->
    <form id="form-template" class="form-template">
        <div class="py-8 border-l-4 border-indigo-500 bg-indigo-50/50">
            <h2 class="form-title text-2xl font-extrabold text-indigo-700 mb-6 flex items-center pb-2 border-b border-indigo-200 px-6">
                <span class="inline-block w-2 h-6 bg-indigo-500 rounded-sm mr-3"></span>
                試產資訊 #1
            </h2>
            <div class="mb-6 px-6">
                <label for="item_name" class="block text-sm font-semibold text-gray-700 mb-1">商品名稱</label>
                <input type="text" id="item_name" name="商品" placeholder="請輸入完整的商品名稱" class="form-input focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 px-6">
                <div>
                    <label for="meeting_date" class="block text-sm font-semibold text-gray-700 mb-1">會議日期</label>
                    <input type="date" id="meeting_date" name="會議日期" class="form-input focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="launch_date" class="block text-sm font-semibold text-gray-700 mb-1">上市日</label>
                    <input type="date" id="launch_date" name="上市日" class="form-input focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="category" class="block text-sm font-semibold text-gray-700 mb-1">品類</label>
                    <select id="category" name="品類" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label for="phase" class="block text-sm font-semibold text-gray-700 mb-1">階段</label>
                    <select id="phase" name="階段" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label for="main_factory" class="block text-sm font-semibold text-gray-700 mb-1">主事廠</label>
                    <select id="main_factory" name="主事廠" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label for="sub_factory" class="block text-sm font-semibold text-gray-700 mb-1">副事廠</label>
                    <select id="sub_factory" name="副事廠" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"><option value="">(無)</option></select>
                </div>
            </div>
        </div>

        <div class="py-8 border-l-4 border-teal-500 bg-teal-50/50 border-t border-gray-200">
            <h2 class="text-2xl font-extrabold text-teal-700 mb-6 flex items-center pb-2 border-b border-teal-200 px-6">
                <span class="inline-block w-2 h-6 bg-teal-500 rounded-sm mr-3"></span>
                異常/優化追蹤
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 px-6 mb-6">
                <div>
                    <label for="proposer" class="block text-sm font-semibold text-gray-700 mb-1">提出者</label>
                    <input type="text" id="proposer" name="提出者" placeholder="請輸入提出者名稱" class="form-input focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="issue_type" class="block text-sm font-semibold text-gray-700 mb-1">類型</label>
                    <select id="issue_type" name="類型" class="form-input bg-white"></select>
                </div>
                <div id="detailed-type-container">
                    <label for="detailed_type" class="block text-sm font-semibold text-gray-700 mb-1">詳細類型</label>
                    <select id="detailed_type" name="詳細類型" class="form-input bg-white"><option value="">(請先選擇類型)</option></select>
                </div>
                <div id="responsible-factory-container" class="hidden-collapse">
                    <label for="responsible_factory" class="block text-sm font-semibold text-gray-700 mb-1">責任廠</label>
                    <select id="responsible_factory" name="責任廠" class="form-input bg-white"><option value="">(無)</option></select>
                </div>
                <div id="responsible-party-container" class="hidden-collapse">
                    <label for="responsible_party" class="block text-sm font-semibold text-gray-700 mb-1">責任端</label>
                    <select id="responsible_party" name="責任端" class="form-input bg-white"><option value="">(無)</option></select>
                </div>
                <div>
                    <label for="recorder" class="block text-sm font-semibold text-gray-700 mb-1">記錄者</label>
                    <input type="text" id="recorder" name="記錄者" placeholder="請輸入記錄者名稱" class="form-input focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="px-6 mt-2 space-y-4">
                <div>
                    <label for="item_description" class="block text-sm font-semibold text-gray-700 mb-1">項目說明</label>
                    <textarea id="item_description" name="項目說明" rows="6" placeholder="請描述本次試產／架上品的異常狀況、優化重點或新增規範內容。" class="form-input h-36 md:h-40 resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>
                <div>
                    <label for="execution_instructions" class="block text-sm font-semibold text-gray-700 mb-1">執行說明</label>
                    <textarea id="execution_instructions" name="執行說明" rows="6" placeholder="請填寫後續處理方式、修正作法、試產調整方向。" class="form-input h-36 md:h-40 resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>

                <!-- 照片上傳 -->
                <div>
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">照片上傳（異常/優化佐證）</label>
                        
                    </div>

                    <!-- 用於記錄目前照片數量（最多 3） -->
                    <input type="hidden" id="photo_count" name="照片數量" value="1">

                    <div id="photo-slots" class="space-y-4">
                        <!-- Slot 1（固定存在） -->
                        <div class="photo-slot border border-gray-200 rounded-xl bg-white p-3" data-slot="1">
                            <div class="text-xs font-semibold text-gray-600 mb-2">照片1</div>

                            <input type="file" id="issue_photo" name="照片檔" accept="image/*" class="form-input bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                            <input type="hidden" id="issue_photo_data" name="照片資料" value="">

                            <div class="mt-3">
                                <div class="text-xs text-gray-500 mb-2"></div>
                                <div class="w-full border border-gray-200 rounded-xl bg-white p-3">
                                    <img id="issue_photo_preview" alt="照片預覽" class="hidden w-full max-h-64 object-contain rounded-lg">
                                    <div id="issue_photo_empty" class="text-sm text-gray-400">尚未上傳照片</div>
</div>
                                <div class="mt-3 flex justify-start">
                                    <button type="button" class="add-photo-btn inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-teal-600 text-white font-bold shadow-md hover:bg-teal-700 focus:ring-4 focus:ring-teal-200 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        新增照片
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="mt-2 text-xs text-gray-500">
                        
                    </div>
                </div>

                <div>
                    <label for="remarks class=" block="" text-sm="" font-semibold="" text-gray-700="" mb-1"="">備註</label>
                    <textarea id="remarks" name="備註" rows="5" placeholder="補充說明其他未涵蓋事項。" class="form-input h-32 md:h-36 resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>
            </div>

            <div id="non-adoption-container" class="px-6 mt-6 hidden-collapse">
                <label for="reason_for_non_adoption" class="block text-sm font-semibold text-gray-700 mb-1">不採用原因(優化)</label>
                <textarea id="reason_for_non_adoption" name="不採用原因(優化)" rows="4" placeholder="請填寫不採納此優化提案的具體原因。" class="form-input resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
            </div>
        </div>

        <div class="flex justify-end space-x-4 p-6 bg-gray-50 border-t border-gray-200">
            <button type="button" class="add-form-btn-local px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 focus:ring-4 focus:ring-indigo-300">新增一筆項目</button>
            <button type="button" class="remove-form-btn px-6 py-2 bg-red-100 text-red-700 font-semibold rounded-lg shadow-md hover:bg-red-200 transition duration-300 focus:ring-4 focus:ring-red-400">移除當前項目</button>
        </div>
    </form>

    <script>
        let formIndex = 0;

        const dropdownOptions = {
            '品類': ['飯糰', '壽司手卷', '主食', '便當', '熱食義麵', '季節調理麵', '沙拉', '小吃', '三明治(調理麵包)', '甜點'],
            '階段': ['架上品', '試產一', '試產二', '試產1-0', '試產1-1', '其他量化'],
            '工廠列表': ['屏榮新豐', '屏榮大溪', '晉欣', '長家', '玉美', '連合發'],
            '責任端': ['生產端', '開發端', '物料端'],
            '類型': ['異常', '優化提案', '優化採用', '新增規範'],
        };

        const detailedOptionsMap = {
            '異常': ['良品設定未完善', '不符合指示書設定', '微波狀態不符合設定', '物料未到樣', '賣相不符合指示書設定', '物料異常'],
            '優化提案': ['效率優化', '製程優化', '其他優化'],
            '優化採用': ['效率優化', '製程優化', '其他優化'],
            '新增規範': [], '': []
        };

        const preloadedData = [{"item_name":"香草可樂風味雲餡泡芙","meeting_date":"2026-02-05","launch_date":"2026-03-17","category":"甜點","phase":"架上品","main_factory":"屏榮大溪","sub_factory":"晉欣"},{"item_name":"起司舒芙蕾布丁(舊檔重開)","meeting_date":"2026-02-05","launch_date":"2027-01-28","category":"甜點","phase":"試產二","main_factory":"屏榮大溪","sub_factory":"晉欣"},{"item_name":"香菜蝦蝦捲","meeting_date":"2026-02-05","launch_date":"2026-03-04","category":"沙拉","phase":"架上品","main_factory":"屏榮大溪","sub_factory":"晉欣"},{"item_name":"冰烤地瓜沙拉","meeting_date":"2026-02-05","launch_date":"2026-03-18","category":"沙拉","phase":"試產一","main_factory":"晉欣","sub_factory":"屏榮大溪"},{"item_name":"溏心蛋洋芋沙拉","meeting_date":"2026-02-05","launch_date":"2027-01-22","category":"沙拉","phase":"試產一","main_factory":"晉欣","sub_factory":"屏榮新豐"},{"item_name":"黃金地瓜菜菜捲","meeting_date":"2026-02-05","launch_date":"2027-01-23","category":"沙拉","phase":"試產一","main_factory":"屏榮新豐","sub_factory":"晉欣"}];

        // ===== Google Apps Script Web App 設定 =====
        const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycby4EafDJN6B6El3M6vL4-qFiWAIxW1_1JZ_TL9QKsj3ggX-d7Dvg7lX0H_ju5l2f0ltIg/exec";
        const GAS_TOKEN = "rice_test_2025"; // 必須與 Apps Script 端 TOKEN 完全一致

        const outputHeaders = [
            { outputName: '會議日期', formName: '會議日期' },
            { outputName: '月', formName: '會議日期', type: 'month_derived' },
            { outputName: '品類', formName: '品類' },
            { outputName: '商品', formName: '商品' },
            { outputName: '階段', formName: '階段' },
            { outputName: '上市日', formName: '上市日', isOptional: true },
            { outputName: '主事廠', formName: '主事廠' },
            { outputName: '副事廠', formName: '副事廠', isOptional: true },
            { outputName: '提出者', formName: '提出者' },
            { outputName: '類型', formName: '類型' },
            { outputName: '詳細類型', formName: '詳細類型' },
            { outputName: '項目說明', formName: '項目說明' },
            { outputName: '執行說明', formName: '執行說明' },
            { outputName: '責任廠 (異常)', formName: '責任廠', isConditional: true, conditionValue: '異常' },
            { outputName: '責任端(異常)', formName: '責任端', isConditional: true, conditionValue: '異常' },
            { outputName: '不採用原因(優化)', formName: '不採用原因(優化)', isConditional: true, conditionValue: '優化提案', isOptional: true },
            { outputName: '備註', formName: '備註', isOptional: true },
            { outputName: '記錄者', formName: '記錄者' }
        ];

        function populateSelect(selectElement, options, defaultText = "(請選擇)") {
            if (!selectElement) return;
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = defaultText;
            selectElement.appendChild(defaultOption);
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }

        // --- Image Upload & Compression (store as DataURL for PPT) ---
        async function downscaleToJpegDataUrl(file, maxSide = 1280, quality = 0.82) {
            const readAsDataURL = (f) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = reject;
                reader.readAsDataURL(f);
            });

            const srcDataUrl = await readAsDataURL(file);

            try {
                const img = new Image();
                img.decoding = 'async';
                img.src = srcDataUrl;
                await new Promise((res, rej) => {
                    img.onload = () => res();
                    img.onerror = rej;
                });

                const w = img.naturalWidth || img.width;
                const h = img.naturalHeight || img.height;
                if (!w || !h) return srcDataUrl;

                const scale = Math.min(1, maxSide / Math.max(w, h));
                const targetW = Math.max(1, Math.round(w * scale));
                const targetH = Math.max(1, Math.round(h * scale));

                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');
                if (!ctx) return srcDataUrl;

                ctx.drawImage(img, 0, 0, targetW, targetH);
                const out = canvas.toDataURL('image/jpeg', quality);
                return out || srcDataUrl;
            } catch (e) {
                return srcDataUrl;
            }
        }

        async function handleIssuePhotoChange(formElement, index, slot = 1) {
            const suffix = `-${index}`;
            const sfx = (slot === 1) ? '' : String(slot);

            const fileInput = formElement.querySelector(`#issue_photo${sfx}${suffix}`);
            const hiddenInput = formElement.querySelector(`#issue_photo_data${sfx}${suffix}`);
            const previewImg = formElement.querySelector(`#issue_photo_preview${sfx}${suffix}`);
            const emptyHint = formElement.querySelector(`#issue_photo_empty${sfx}${suffix}`);

            if (!fileInput || !hiddenInput || !previewImg || !emptyHint) return;
            const file = fileInput.files && fileInput.files[0];

            if (!file) {
                hiddenInput.value = '';
                previewImg.src = '';
                previewImg.classList.add('hidden');
                emptyHint.classList.remove('hidden');
                return;
            }

            if (!file.type || !file.type.startsWith('image/')) {
                alert('請上傳圖片檔（image/*）。');
                fileInput.value = '';
                return;
            }

            const dataUrl = await downscaleToJpegDataUrl(file, 1280, 0.82);
            hiddenInput.value = dataUrl;

            previewImg.src = dataUrl;
            previewImg.classList.remove('hidden');
            emptyHint.classList.add('hidden');
        }

        // --- 多照片：新增 Slot（最多 3 張） ---
        function addPhotoSlot(formElement, index) {
            const suffix = `-${index}`;
            const countInput = formElement.querySelector(`#photo_count${suffix}`);
            const slotsContainer = formElement.querySelector(`#photo-slots${suffix}`);
            const addBtn = formElement.querySelector(`.add-photo-btn`);

            if (!countInput || !slotsContainer) return;

            const current = Math.max(1, parseInt(countInput.value || '1', 10) || 1);
            if (current >= 3) {
                if (addBtn) addBtn.disabled = true;
                alert('最多只能新增 3 張照片。');
                return;
            }

            const nextSlot = current + 1;
            countInput.value = String(nextSlot);

            // 建立 slot DOM（slot 2 / 3）
            const wrapper = document.createElement('div');
            wrapper.className = 'photo-slot border border-gray-200 rounded-xl bg-white p-3';
            wrapper.dataset.slot = String(nextSlot);

            const sfx = String(nextSlot);
            wrapper.innerHTML = `
                <div class="text-xs font-semibold text-gray-600 mb-2">照片${sfx}</div>

                <input type="file" id="issue_photo${sfx}${suffix}" name="照片檔${sfx}" accept="image/*"
                    class="form-input bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100" />
                <input type="hidden" id="issue_photo_data${sfx}${suffix}" name="照片資料${sfx}" value="" />

                <div class="mt-3">
                    <div class="w-full border border-gray-200 rounded-xl bg-white p-3">
                        <img id="issue_photo_preview${sfx}${suffix}" alt="照片預覽" class="hidden w-full max-h-64 object-contain rounded-lg" />
                        <div id="issue_photo_empty${sfx}${suffix}" class="text-sm text-gray-400">尚未上傳照片</div>
                    </div>
                </div>
            `;

            slotsContainer.appendChild(wrapper);

            const fileInput = wrapper.querySelector(`#issue_photo${sfx}${suffix}`);
            if (fileInput) {
                fileInput.addEventListener('change', () => handleIssuePhotoChange(formElement, index, nextSlot));
            }

            // 3 張後就停用新增按鈕
            if (nextSlot >= 3 && addBtn) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- PPT Generation Logic (Production PPT 版型：內容頁；已移除封面/大綱) ---
        async function generatePPT() {
            const pptx = new PptxGenJS();
            // 對齊你提供的 Production PPT 版型：WIDE (13.333 x 7.5)
            pptx.layout = 'LAYOUT_WIDE';

            // ===== Helpers: Production 版型（內容頁） =====
            const W = 13.333;
            const H = 7.5;
            const FONT = 'Microsoft JhengHei';
            const COLOR_BLUE = '1D4ED8';
            const COLOR_GREEN = '16A34A';
            const COLOR_ORANGE = 'F59E0B';
            const FILL_YELLOW = 'FFF2CC';
            const TEXT = '111111';

            const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

            async function addImageContain(slide, dataUrl, box) {
                // 瀏覽器端讀取圖片尺寸，做 contain 等比例置中
                const dim = await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve({ iw: img.naturalWidth || img.width, ih: img.naturalHeight || img.height });
                    img.onerror = () => resolve({ iw: 1, ih: 1 });
                    img.src = dataUrl;
                });

                const iw = Math.max(1, dim.iw);
                const ih = Math.max(1, dim.ih);
                const boxAR = box.w / box.h;
                const imgAR = iw / ih;

                let drawW, drawH;
                if (imgAR >= boxAR) { drawW = box.w; drawH = box.w / imgAR; }
                else { drawH = box.h; drawW = box.h * imgAR; }

                drawW = clamp(drawW, 0.01, box.w);
                drawH = clamp(drawH, 0.01, box.h);

                const dx = box.x + (box.w - drawW) / 2;
                const dy = box.y + (box.h - drawH) / 2;

                slide.addImage({ data: dataUrl, x: dx, y: dy, w: drawW, h: drawH });
            }

            function addProductionContentSlide(pptx, payload) {
                const slide = pptx.addSlide();

                // 上雙色線（藍 + 綠）
                const topY1 = 0.30;
                const topY2 = topY1 + 0.05;
                slide.addShape(pptx.ShapeType.line, { x: 0, y: topY1, w: W, h: 0, line: { color: COLOR_BLUE, width: 1 } });
                slide.addShape(pptx.ShapeType.line, { x: 0, y: topY2, w: W, h: 0, line: { color: COLOR_GREEN, width: 1 } });

                // 左上角章節/階段
                slide.addText(payload.phaseText || '參、（階段）', {
                    x: 0.30, y: 0.10, w: 6.0, h: 0.35,
                    fontFace: FONT, fontSize: 14, color: TEXT,
                    align: 'left', valign: 'top'
                });

                // 置中大標題： （商品名稱）（優化類型）
                slide.addText(`（${payload.productName || '商品名稱'}）（${payload.optType || '優化類型'}）`, {
                    x: 0.50, y: 0.55, w: W - 1.0, h: 0.80,
                    fontFace: FONT, fontSize: 36, color: TEXT,
                    align: 'center', valign: 'mid'
                });

                // 圖片區
                const descBoxH = 1.95;
                const footerAreaH = 0.35;

                // 原本單張照片的大圖框（只上傳 1 張時維持原規格，不做分欄縮放）
                const imgBoxFull = {
                    x: 1.25,
                    y: 1.55,
                    w: W - 2.50,
                    h: H - 1.55 - descBoxH - footerAreaH - 0.15
                };

                const photos = Array.isArray(payload.photoDataUrls) ? payload.photoDataUrls.filter(u => u && u.startsWith('data:image/')) : [];

                if (!photos || photos.length === 0) {
                    slide.addText('（照片位置）', {
                        x: imgBoxFull.x, y: imgBoxFull.y + imgBoxFull.h / 2 - 0.2, w: imgBoxFull.w, h: 0.4,
                        fontFace: FONT, fontSize: 18, color: '666666',
                        align: 'center', valign: 'mid'
                    });
                } else if (photos.length === 1) {
                    // ✅ 只有 1 張：不分欄，不縮放版面（維持原大圖框）
                    slide.__imgJobs = slide.__imgJobs || [];
                    slide.__imgJobs.push({ dataUrl: photos[0], box: imgBoxFull });
                } else {
                    // ✅ 只有在 2～3 張時：才分欄、縮放圖片區（符合需求）
                    const n = Math.min(3, photos.length);

                    const captionH = 0.28;
                    const captionGap = 0.05;

                    const imgBox = {
                        x: imgBoxFull.x,
                        y: imgBoxFull.y,
                        w: imgBoxFull.w,
                        h: imgBoxFull.h - captionH - captionGap
                    };

                    const gap = 0.35;
                    const eachW = (imgBox.w - gap * (n - 1)) / n;

                    slide.__imgJobs = slide.__imgJobs || [];

                    for (let i = 0; i < n; i++) {
                        const box = {
                            x: imgBox.x + i * (eachW + gap),
                            y: imgBox.y,
                            w: eachW,
                            h: imgBox.h
                        };
                        slide.__imgJobs.push({ dataUrl: photos[i], box });

                        // 照片標籤（紅字）：照片1/2/3（左到右）
                        slide.addText(`照片${i + 1}`, {
                            x: box.x, y: imgBox.y + imgBox.h + captionGap,
                            w: box.w, h: captionH,
                            fontFace: FONT, fontSize: 18, color: 'FF0000',
                            align: 'center', valign: 'mid'
                        });
                    }
                }

                // 底部說明框（淺黃底 + 橘框）
                const descBox = {
                    x: 0.55,
                    y: H - descBoxH - 0.45,
                    w: W - 1.10,
                    h: descBoxH
                };

                slide.addShape(pptx.ShapeType.rect, {
                    x: descBox.x, y: descBox.y, w: descBox.w, h: descBox.h,
                    fill: { color: FILL_YELLOW },
                    line: { color: COLOR_ORANGE, width: 1.5 }
                });

                const d1 = (payload.desc1 || '').trim();
                const d2 = (payload.desc2 || '').trim();
                const text = `${d1 || '（說明）'}\n${d2 || '（詳細說明）'}`;

                slide.addText(text, {
                    x: descBox.x + 0.18, y: descBox.y + 0.18,
                    w: descBox.w - 0.36, h: descBox.h - 0.36,
                    fontFace: FONT, fontSize: 20, color: TEXT,
                    align: 'left', valign: 'top',
                    lineSpacingMultiple: 1.1
                });

                // 下雙色線（藍 + 綠）
                const botY1 = H - 0.35;
                const botY2 = botY1 + 0.05;
                slide.addShape(pptx.ShapeType.line, { x: 0, y: botY1, w: W, h: 0, line: { color: COLOR_BLUE, width: 1 } });
                slide.addShape(pptx.ShapeType.line, { x: 0, y: botY2, w: W, h: 0, line: { color: COLOR_GREEN, width: 1 } });

                // 保密文字
                slide.addText('本文件為「全家便利商店股份有限公司」所有，請勿外洩', {
                    x: 0.50, y: H - 0.28, w: W - 1.0, h: 0.25,
                    fontFace: FONT, fontSize: 10, color: '333333',
                    align: 'center', valign: 'mid'
                });

                return slide;
            }

            async function finalizeProductionImages(pptx) {
                const slides = pptx._slides || [];
                for (const s of slides) {
                    const jobs = s.__imgJobs || [];
                    for (const job of jobs) {
                        await addImageContain(s, job.dataUrl, job.box);
                    }
                    delete s.__imgJobs;
                }
            }

            // ===== 取得會議日期（用第一筆） =====
            const firstForm = document.querySelector('.tracking-form-instance');
            let meetingDate = 'YYYY/MM/DD';
            if (firstForm) {
                const dateInput = firstForm.querySelector('input[name="會議日期"]');
                if (dateInput && dateInput.value) meetingDate = dateInput.value.replace(/-/g, '/');
            }

            // ✅ 已移除封面頁（第1頁）與大綱頁（第2頁），只輸出內容頁

            const forms = document.querySelectorAll('.tracking-form-instance');
            let hasContent = false;

            forms.forEach((form) => {
                const fd = new FormData(form);

                const productName = (fd.get('商品') || '').trim();
                const phase = (fd.get('階段') || '').trim();

                // 優先用「詳細類型」，若空則用「類型」
                const optType = ((fd.get('詳細類型') || '').trim()) || ((fd.get('類型') || '').trim());

                const description = (fd.get('項目說明') || '').trim();
                const execution = (fd.get('執行說明') || '').trim();
                const p1 = (fd.get('照片資料') || '').toString();
                const p2 = (fd.get('照片資料2') || '').toString();
                const p3 = (fd.get('照片資料3') || '').toString();
                const photoDataUrls = [p1, p2, p3].filter(u => u && u.startsWith('data:image/'));

                if (description !== '' || execution !== '') {
                    hasContent = true;
                    addProductionContentSlide(pptx, {
                        phaseText: `參、${phase || '（階段）'}`,
                        productName: productName || '商品名稱',
                        optType: optType || '優化類型',
                        desc1: description || '（說明）',
                        desc2: execution || '（詳細說明）',
                        photoDataUrls: photoDataUrls
                    });
                }
            });

            if (!hasContent) {
                alert('目前沒有任何表單填寫了「項目說明」或「執行說明」，因此未生成內容投影片。');
                return;
            }

            // 將圖片以 contain 等比例置中實際塞入
            await finalizeProductionImages(pptx);

            await pptx.writeFile({ fileName: `製管會報告_${meetingDate.replace(/\//g, '')}.pptx` });
        }

        function openMobileTOC() {
            const drawer = document.getElementById('mobile-toc-drawer');
            const backdrop = document.getElementById('mobile-toc-backdrop');
            if (!drawer || !backdrop) return;
            backdrop.classList.remove('hidden');
            drawer.classList.remove('-translate-x-full');
            document.body.classList.add('overflow-hidden');
        }
        function closeMobileTOC() {
            const drawer = document.getElementById('mobile-toc-drawer');
            const backdrop = document.getElementById('mobile-toc-backdrop');
            if (!drawer || !backdrop) return;
            drawer.classList.add('-translate-x-full');
            backdrop.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        function cleanItemName(name) { return name.replace(/[\(（].*?[\)）]/g, '').trim(); }

        function renderTOCInto(containerEl, forms) {
            if (!containerEl) return;
            containerEl.innerHTML = '';
            if (forms.length === 0) {
                containerEl.innerHTML = '<p class="text-sm text-gray-400">尚無項目可供追蹤。</p>';
                return;
            }
            forms.forEach((form, index) => {
                const suffix = form.id.split('-').pop();
                const itemInput = form.querySelector(`#item_name-${suffix}`);
                const rawItemName = itemInput ? itemInput.value : '';
                const cleanedName = cleanItemName(rawItemName) || `(項目 #${index + 1}: 待填寫)`;
                const targetId = form.id;

                const link = document.createElement('a');
                link.href = `#${targetId}`;
                link.textContent = cleanedName;
                link.className = 'block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate';
                link.title = rawItemName;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    setActiveForm(targetId);
                    closeMobileTOC();
                });
                containerEl.appendChild(link);
            });
        }

        function updateTOC() {
            const forms = Array.from(document.querySelectorAll('.tracking-form-instance'));
            renderTOCInto(document.getElementById('toc-container-desktop'), forms);
            renderTOCInto(document.getElementById('toc-container-mobile'), forms);
            updatePagerUI();
        }

        function updateDetailedType(formElement, index) {
            const issueTypeSelect = formElement.querySelector(`#issue_type-${index}`);
            if (!issueTypeSelect) return;

            const detailedTypeContainer = formElement.querySelector(`#detailed-type-container-${index}`);
            const detailedTypeSelect = formElement.querySelector(`#detailed_type-${index}`);
            const selectedType = issueTypeSelect.value;
            const requiredDisplay = (selectedType in detailedOptionsMap && detailedOptionsMap[selectedType].length > 0);

            if (requiredDisplay) {
                detailedTypeContainer.classList.remove('hidden-collapse');
                detailedTypeSelect.required = false;
                populateSelect(detailedTypeSelect, detailedOptionsMap[selectedType], "(請選擇詳細類型)");
            } else {
                detailedTypeContainer.classList.add('hidden-collapse');
                detailedTypeSelect.required = false;
                detailedTypeSelect.value = '';
            }
        }

        function updateConditionalFields(formElement, index) {
            const issueTypeSelect = formElement.querySelector(`#issue_type-${index}`);
            if (!issueTypeSelect) return;

            const selectedType = issueTypeSelect.value;
            const isException = selectedType === '異常';
            const isOptimizationProposal = selectedType === '優化提案';

            const respFactoryContainer = formElement.querySelector(`#responsible-factory-container-${index}`);
            const respPartyContainer = formElement.querySelector(`#responsible-party-container-${index}`);
            const respFactorySelect = formElement.querySelector(`#responsible_factory-${index}`);
            const respPartySelect = formElement.querySelector(`#responsible_party-${index}`);

            if (isException) {
                respFactoryContainer.classList.remove('hidden-collapse');
                respPartyContainer.classList.remove('hidden-collapse');
                respFactorySelect.required = false;
                respPartySelect.required = false;
            } else {
                respFactoryContainer.classList.add('hidden-collapse');
                respPartyContainer.classList.add('hidden-collapse');
                respFactorySelect.required = false;
                respPartySelect.required = false;
                respFactorySelect.value = '';
                respPartySelect.value = '';
            }

            const nonAdoptionContainer = formElement.querySelector(`#non-adoption-container-${index}`);
            const nonAdoptionTextarea = formElement.querySelector(`#reason_for_non_adoption-${index}`);

            if (isOptimizationProposal) {
                nonAdoptionContainer.classList.remove('hidden-collapse');
                nonAdoptionTextarea.required = false;
            } else {
                nonAdoptionContainer.classList.add('hidden-collapse');
                nonAdoptionTextarea.required = false;
                nonAdoptionTextarea.value = '';
            }
        }

        function reIndexForms() {
            const forms = document.querySelectorAll('.tracking-form-instance');
            forms.forEach((form, newIndex) => {
                const titleElement = form.querySelector('.form-title');
                if (titleElement) titleElement.textContent = `試產資訊 #${newIndex + 1}`;
            });
        }

        function removeFormInstance(formElement) {
            const wasActive = formElement.classList.contains('is-active');
            const allBefore = Array.from(document.querySelectorAll('.tracking-form-instance'));
            const removeIndex = allBefore.indexOf(formElement);

            formElement.remove();

            const forms = Array.from(document.querySelectorAll('.tracking-form-instance'));
            if (forms.length === 0) {
                cloneAndInitializeForm();
                return;
            }

            if (wasActive) {
                const nextCandidate = forms[Math.min(removeIndex, forms.length - 1)] || forms[0];
                setActiveForm(nextCandidate.id);
            }

            reIndexForms();
            updateTOC();
        }

        function initializeFormInstance(formElement, index, dataToPreFill = {}) {
            formElement.classList.add('form-page');
            formElement.id = `tracking-form-instance-${index}`;

            const titleElement = formElement.querySelector('.form-title');
            if (titleElement) titleElement.textContent = `試產資訊 #${document.querySelectorAll('.tracking-form-instance').length}`;

            const suffix = `-${index}`;
            formElement.querySelectorAll('[id], [for]').forEach(el => {
                if (el.id && !el.id.endsWith(suffix)) el.id += suffix;
                if (el.hasAttribute('for') && !el.getAttribute('for').endsWith(suffix)) el.setAttribute('for', el.getAttribute('for') + suffix);
            });

            const selectMap = {
                'category': { options: dropdownOptions['品類'], default: "(請選擇)" },
                'phase': { options: dropdownOptions['階段'], default: "(請選擇)" },
                'main_factory': { options: dropdownOptions['工廠列表'], default: "(請選擇)" },
                'sub_factory': { options: dropdownOptions['工廠列表'], default: "(無)" },
                'issue_type': { options: dropdownOptions['類型'], default: "(請選擇)" },
                'responsible_factory': { options: dropdownOptions['工廠列表'], default: "(無)" },
                'responsible_party': { options: dropdownOptions['責任端'], default: "(無)" }
            };

            Object.keys(selectMap).forEach(baseId => {
                const selectEl = formElement.querySelector(`#${baseId}${suffix}`);
                if (selectEl) populateSelect(selectEl, selectMap[baseId].options, selectMap[baseId].default);
            });

            if (dataToPreFill && Object.keys(dataToPreFill).length > 0) {
                const fields = {
                    'item_name': dataToPreFill.item_name,
                    'meeting_date': dataToPreFill.meeting_date,
                    'launch_date': dataToPreFill.launch_date,
                    'category': dataToPreFill.category,
                    'phase': dataToPreFill.phase,
                    'main_factory': dataToPreFill.main_factory,
                    'sub_factory': dataToPreFill.sub_factory || ''
                };
                for (const [key, value] of Object.entries(fields)) {
                    if (value) {
                        const input = formElement.querySelector(`#${key}${suffix}`);
                        if (input) input.value = value;
                    }
                }
            }

            const issueTypeSelect = formElement.querySelector(`#issue_type${suffix}`);
            if (issueTypeSelect) {
                updateDetailedType(formElement, index);
                updateConditionalFields(formElement, index);

                issueTypeSelect.addEventListener('change', () => {
                    updateDetailedType(formElement, index);
                    updateConditionalFields(formElement, index);
                });
            }

            const itemNameInput = formElement.querySelector(`#item_name${suffix}`);
            if (itemNameInput) itemNameInput.addEventListener('input', updateTOC);

            const removeBtn = formElement.querySelector('.remove-form-btn');
            if (removeBtn) removeBtn.addEventListener('click', () => removeFormInstance(formElement));

            const addLocalBtn = formElement.querySelector('.add-form-btn-local');
            if (addLocalBtn) addLocalBtn.addEventListener('click', () => { cloneAndInitializeForm(); updateTOC(); });

            const photoInput = formElement.querySelector(`#issue_photo${suffix}`);
            if (photoInput) photoInput.addEventListener('change', () => handleIssuePhotoChange(formElement, index, 1));

            // 多照片新增按鈕
            const addPhotoBtn = formElement.querySelector(`.add-photo-btn`);
            const countInput = formElement.querySelector(`#photo_count${suffix}`);
            if (countInput) countInput.value = '1';
            if (addPhotoBtn) {
                addPhotoBtn.disabled = false;
                addPhotoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                addPhotoBtn.addEventListener('click', () => addPhotoSlot(formElement, index));
            }
        }

        function cloneAndInitializeForm(dataToPreFill) {
            const templateForm = document.getElementById('form-template');
            const formsWrapper = document.getElementById('forms-wrapper');
            const newForm = templateForm.cloneNode(true);
            newForm.classList.remove('form-template');
            newForm.classList.add('tracking-form-instance');
            newForm.classList.add('form-page');

            const currentForms = document.querySelectorAll('.tracking-form-instance');
            formsWrapper.appendChild(newForm);

            const uniqueIndex = formIndex++;
            initializeFormInstance(newForm, uniqueIndex, dataToPreFill);

            setActiveForm(newForm.id);

            if (!dataToPreFill && currentForms.length > 0) {
                const main = document.getElementById('main-container');
                if (main) main.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            reIndexForms();
            updateTOC();
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            const headerArray = outputHeaders.map(h => h.outputName);
            const csvHeader = headerArray.map(key => `"${key.replace(/"/g, '""')}"`).join(',');

            const csvRows = data.map(row => {
                return headerArray.map(header => {
                    let value = row[header] === undefined ? '' : String(row[header]);
                    value = value.replace(/\n/g, ' ').replace(/"/g, '""');
                    return `"${value}"`;
                }).join(',');
            }).join('\n');

            return csvHeader + '\n' + csvRows;
        }

        // 原本保留的下載函式（若你未來要用，先不刪）
        function downloadCSV(csvString, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ✅ 上傳（避免 Failed to fetch / CORS）：使用 no-cors + text/plain
        async function handleSubmission() {
            const forms = document.querySelectorAll('.tracking-form-instance');
            const allFormData = [];

            if (forms.length === 0) {
                alert('目前沒有任何表單資料可上傳。');
                return;
            }

            // 1) 收集資料 -> allFormData（沿用既有 outputHeaders 規則）
            forms.forEach((form) => {
                const data = {};
                const formData = new FormData(form);
                const issueType = formData.get('類型');

                outputHeaders.forEach(header => {
                    const formName = header.formName;
                    const outputName = header.outputName;
                    let value = "";

                    if (header.type === 'month_derived') {
                        const dateValue = formData.get('會議日期');
                        if (dateValue && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            const parts = dateValue.split('-');
                            const dateObj = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                            value = dateObj.getUTCMonth() + 1;
                        } else {
                            value = "";
                        }
                    } else {
                        value = formData.get(formName) ? String(formData.get(formName)).trim() : "";
                        if (header.isConditional) {
                            if (issueType !== header.conditionValue) value = "";
                        }
                    }

                    data[outputName] = value ?? "";
                });

                allFormData.push(data);
            });

            // 2) 產生 CSV
            const csvContent = convertToCSV(allFormData);

            // 3) 檔名：優先用第一筆會議日期（YYYYMMDD），否則用今日
            let meetingDate = "";
            const first = forms[0];
            if (first) {
                const d = first.querySelector('input[name="會議日期"]');
                if (d && d.value) meetingDate = d.value.replace(/-/g, '');
            }
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const fileDate = meetingDate || today;
            const filename = `製管會項目數據_${fileDate}.csv`;

            if (!GAS_WEBAPP_URL) {
                alert("尚未設定 GAS_WEBAPP_URL，請先貼上 Apps Script Web App URL。");
                return;
            }

            // 4) CSV -> base64（UTF-8）
            const base64 = btoa(unescape(encodeURIComponent(csvContent)));

            // 5) UI：避免重複點擊
            const btn = document.getElementById('submit-all-btn');
            const originalText = btn ? btn.textContent : "上傳報表";
            if (btn) { btn.disabled = true; btn.textContent = "上傳中..."; }

            try {
                // no-cors 會回傳 opaque response，但可避免 CORS preflight 導致 Failed to fetch
                await fetch(GAS_WEBAPP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        token: GAS_TOKEN,
                        filename,
                        base64: "data:text/csv;base64," + base64
                    })
                });

                alert("已送出上傳請求。請到 Google Drive 目標資料夾確認檔案是否已新增。");

                // 6) 顯示 CSV 內容（不含連結，因為 no-cors 無法讀取回傳）
                const outputSection = document.getElementById('output-section');
                const formOutput = document.getElementById('form-output');
                const formCountOutput = document.getElementById('form-count-output');

                if (formCountOutput) formCountOutput.textContent = allFormData.length;

                const text = "（已送出上傳請求；此模式因 CORS 限制無法顯示 Drive 連結）\n\n" + csvContent;
                if (formOutput) formOutput.textContent = text;

                if (outputSection) {
                    outputSection.classList.remove('hidden');
                    outputSection.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (err) {
                alert("上傳失敗：" + String(err && err.message ? err.message : err));
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = originalText; }
            }
        }

        function getFormsArray() {
            return Array.from(document.querySelectorAll('.tracking-form-instance'));
        }

        function setActiveForm(targetId) {
            const forms = getFormsArray();
            if (forms.length === 0) return;

            const target = document.getElementById(targetId) || forms[0];
            forms.forEach(f => f.classList.remove('is-active'));
            target.classList.add('is-active');

            updatePagerUI();

            const main = document.getElementById('main-container');
            if (main) main.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updatePagerUI() {
            const forms = getFormsArray();
            const indicator = document.getElementById('pager-indicator');
            const prevBtn = document.getElementById('prev-form-btn');
            const nextBtn = document.getElementById('next-form-btn');

            if (!indicator || !prevBtn || !nextBtn) return;

            const activeIndex = Math.max(0, forms.findIndex(f => f.classList.contains('is-active')));
            const total = forms.length;
            const current = total === 0 ? 0 : activeIndex + 1;

            indicator.textContent = `目前：${current} / ${total}`;
            prevBtn.disabled = (total === 0 || activeIndex <= 0);
            nextBtn.disabled = (total === 0 || activeIndex >= total - 1);
        }

        function goPrevForm() {
            const forms = getFormsArray();
            if (forms.length === 0) return;
            const activeIndex = forms.findIndex(f => f.classList.contains('is-active'));
            const target = forms[Math.max(0, activeIndex - 1)] || forms[0];
            setActiveForm(target.id);
        }

        function goNextForm() {
            const forms = getFormsArray();
            if (forms.length === 0) return;
            const activeIndex = forms.findIndex(f => f.classList.contains('is-active'));
            const target = forms[Math.min(forms.length - 1, activeIndex + 1)] || forms[forms.length - 1];
            setActiveForm(target.id);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const openBtn = document.getElementById('mobile-toc-open-btn');
            const closeBtn = document.getElementById('mobile-toc-close-btn');
            const backdrop = document.getElementById('mobile-toc-backdrop');
            if (openBtn) openBtn.addEventListener('click', openMobileTOC);
            if (closeBtn) closeBtn.addEventListener('click', closeMobileTOC);
            if (backdrop) backdrop.addEventListener('click', closeMobileTOC);

            if (preloadedData && preloadedData.length > 0) {
                preloadedData.forEach(data => cloneAndInitializeForm(data));
            } else {
                cloneAndInitializeForm();
            }

            const forms = getFormsArray();
            if (forms.length > 0) {
                // 預設顯示第一筆
                setActiveForm(forms[0].id);
            }

            updateTOC();

            const prevBtn = document.getElementById('prev-form-btn');
            const nextBtn = document.getElementById('next-form-btn');
            if (prevBtn) prevBtn.addEventListener('click', goPrevForm);
            if (nextBtn) nextBtn.addEventListener('click', goNextForm);

            const submitBtn = document.getElementById('submit-all-btn');
            if (submitBtn) submitBtn.addEventListener('click', handleSubmission);

            const pptBtn = document.getElementById('download-ppt-btn');
            if (pptBtn) pptBtn.addEventListener('click', () => generatePPT());

            // ====== 匯入表格：事件綁定（新增） ======
            const btnOpenImport = document.getElementById("btnOpenImport");
            const fileImport = document.getElementById("fileImport");
            const status = document.getElementById("importStatus");

            const txtImport = document.getElementById("txtImport");
            const btnParseText = document.getElementById("btnParseText");
            const btnParseTextReplace = document.getElementById("btnParseTextReplace");
            const btnClearText = document.getElementById("btnClearText");

            const btnReplaceAll = document.getElementById("btnReplaceAll");

            if (btnOpenImport && fileImport) {
                btnOpenImport.addEventListener("click", () => fileImport.click());

                fileImport.addEventListener("change", async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;

                    try {
                        status.textContent = `讀取中：${file.name}`;
                        const imported = await parseFileToImportObjects(file);
                        const prefills = imported.map(toPreFillObject);
                        applyImportedPrefills(prefills, "append");
                        status.textContent = `匯入完成：${prefills.length} 筆（追加）`;
                    } catch (err) {
                        console.error(err);
                        status.textContent = `匯入失敗：${err.message || err}`;
                    } finally {
                        fileImport.value = "";
                    }
                });
            }

            if (btnReplaceAll && fileImport) {
                btnReplaceAll.addEventListener("click", () => {
                    const handler = async (e) => {
                        const file = e.target.files?.[0];
                        if (!file) return;
                        try {
                            status.textContent = `讀取中：${file.name}`;
                            const imported = await parseFileToImportObjects(file);
                            const prefills = imported.map(toPreFillObject);
                            applyImportedPrefills(prefills, "replace");
                            status.textContent = `匯入完成：${prefills.length} 筆（覆蓋）`;
                        } catch (err) {
                            console.error(err);
                            status.textContent = `匯入失敗：${err.message || err}`;
                        } finally {
                            fileImport.value = "";
                            fileImport.removeEventListener("change", handler);
                        }
                    };
                    fileImport.addEventListener("change", handler);
                    fileImport.click();
                });
            }

            if (btnParseText && txtImport) {
                btnParseText.addEventListener("click", () => {
                    try {
                        const imported = parsePastedTextToImportObjects(txtImport.value);
                        const prefills = imported.map(toPreFillObject);
                        applyImportedPrefills(prefills, "append");
                        status.textContent = `匯入完成：${prefills.length} 筆（貼上追加）`;
                    } catch (err) {
                        console.error(err);
                        status.textContent = `解析失敗：${err.message || err}`;
                    }
                });
            }

            if (btnParseTextReplace && txtImport) {
                btnParseTextReplace.addEventListener("click", () => {
                    try {
                        const imported = parsePastedTextToImportObjects(txtImport.value);
                        const prefills = imported.map(toPreFillObject);
                        applyImportedPrefills(prefills, "replace");
                        status.textContent = `匯入完成：${prefills.length} 筆（貼上覆蓋）`;
                    } catch (err) {
                        console.error(err);
                        status.textContent = `解析失敗：${err.message || err}`;
                    }
                });
            }

            if (btnClearText && txtImport) {
                btnClearText.addEventListener("click", () => {
                    txtImport.value = "";
                    if (status) status.textContent = "";
                });
            }
        });

        // ====== 匯入表格：解析/套用（新增） ======
        const IMPORT_HEADERS = ["會議日期","品類","商品","階段","上市日","主事廠","副事廠"];
        const IMPORT_ALIASES = {
            "會議日期": ["會議日期","會議日","日期","meeting_date"],
            "品類": ["品類","分類","category"],
            "商品": ["商品","商品名稱","品名","item","item_name"],
            "階段": ["階段","階別","phase"],
            "上市日": ["上市日","上市日期","launch_date"],
            "主事廠": ["主事廠","主廠","主責工廠","main_factory"],
            "副事廠": ["副事廠","副廠","協力工廠","sub_factory"]
        };

        function _norm(s) {
            return String(s ?? "").replace(/\s+/g, "").replace(/：/g, "").trim().toLowerCase();
        }

        function _detectDelimiter(line) {
            if (line.includes("\t")) return "\t";
            if (line.includes(",")) return ",";
            return "\t";
        }

        function _splitLine(line, delimiter) {
            return line.split(delimiter).map(v => String(v ?? "").trim());
        }

        function _excelSerialToYMD(serial) {
            const n = Number(serial);
            if (!isFinite(n)) return "";
            const utcMs = Math.round((n - 25569) * 86400 * 1000);
            const d = new Date(utcMs);
            if (isNaN(d.getTime())) return "";
            const y = d.getUTCFullYear();
            const m = String(d.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(d.getUTCDate()).padStart(2, "0");
            return `${y}-${m}-${dd}`;
        }

        function _toDateInputValue(value, meetingDateYMD = "") {
            if (value === null || value === undefined) return "";
            const v = String(value).trim();
            if (!v) return "";

            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;

            const m1 = v.match(/^(\d{4})[\/\.](\d{1,2})[\/\.](\d{1,2})$/);
            if (m1) {
                const y = m1[1];
                const m = String(Number(m1[2])).padStart(2, "0");
                const d = String(Number(m1[3])).padStart(2, "0");
                return `${y}-${m}-${d}`;
            }

            const m2 = v.match(/^(\d{1,2})\/(\d{1,2})$/);
            if (m2) {
                const mm = Number(m2[1]);
                const dd = Number(m2[2]);
                const base = meetingDateYMD || "";
                let y = base ? Number(base.slice(0,4)) : new Date().getFullYear();
                if (base) {
                    const baseM = Number(base.slice(5,7));
                    const baseD = Number(base.slice(8,10));
                    if (mm < baseM || (mm === baseM && dd < baseD)) y += 1;
                }
                return `${y}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
            }

            const m3 = v.match(/^(\d{1,2})\s*月\s*(\d{1,2})\s*日$/);
            if (m3) {
                const mm = Number(m3[1]);
                const dd = Number(m3[2]);
                const base = meetingDateYMD || "";
                let y = base ? Number(base.slice(0,4)) : new Date().getFullYear();
                if (base) {
                    const baseM = Number(base.slice(5,7));
                    const baseD = Number(base.slice(8,10));
                    if (mm < baseM || (mm === baseM && dd < baseD)) y += 1;
                }
                return `${y}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
            }

            if (/^\d{5,6}(\.\d+)?$/.test(v)) {
                const ymd = _excelSerialToYMD(v);
                if (ymd) return ymd;
            }

            return "";
        }

        function _buildHeaderIndex(headerRow) {
            const headerNorm = headerRow.map(h => _norm(h));
            const idx = {};

            for (const key of IMPORT_HEADERS) {
                const aliases = IMPORT_ALIASES[key] || [key];
                let found = -1;
                for (const a of aliases) {
                    const i = headerNorm.findIndex(h => h === _norm(a));
                    if (i >= 0) { found = i; break; }
                }
                if (found >= 0) idx[key] = found;
            }
            return idx;
        }

        function _mapAoaToImportObjects(aoa) {
            const header = aoa[0] || [];
            const idx = _buildHeaderIndex(header);

            const missing = IMPORT_HEADERS.filter(h => idx[h] === undefined);
            if (missing.length) throw new Error("缺少欄位：" + missing.join("、"));

            const out = [];
            for (let r = 1; r < aoa.length; r++) {
                const row = aoa[r] || [];
                const obj = {};
                for (const h of IMPORT_HEADERS) obj[h] = String(row[idx[h]] ?? "").trim();
                if (obj["商品"]) out.push(obj);
            }
            return out;
        }

        async function parseFileToImportObjects(file) {
            const ext = (file.name.split(".").pop() || "").toLowerCase();

            if (ext === "xlsx" || ext === "xls") {
                if (typeof XLSX === "undefined") throw new Error("未載入 XLSX 套件。");
                const ab = await file.arrayBuffer();
                const wb = XLSX.read(ab, { type: "array" });
                const wsName = wb.SheetNames[0];
                const ws = wb.Sheets[wsName];
                const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: "" });
                return _mapAoaToImportObjects(aoa);
            }

            const text = await file.text();
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            if (lines.length < 2) throw new Error("至少需要 1 行表頭 + 1 行資料。");
            const delimiter = _detectDelimiter(lines[0]);
            const aoa = lines.map(line => _splitLine(line, delimiter));
            return _mapAoaToImportObjects(aoa);
        }

        function parsePastedTextToImportObjects(text) {
            const lines = String(text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            if (lines.length < 2) throw new Error("至少需要 1 行表頭 + 1 行資料。");
            const delimiter = _detectDelimiter(lines[0]);
            const aoa = lines.map(line => _splitLine(line, delimiter));
            return _mapAoaToImportObjects(aoa);
        }

        function toPreFillObject(importObj) {
            const meetingYMD = _toDateInputValue(importObj["會議日期"]);
            return {
                item_name: importObj["商品"] || "",
                meeting_date: meetingYMD,
                launch_date: _toDateInputValue(importObj["上市日"], meetingYMD),
                category: importObj["品類"] || "",
                phase: importObj["階段"] || "",
                main_factory: importObj["主事廠"] || "",
                sub_factory: importObj["副事廠"] || ""
            };
        }

        function _clearAllFormInstances() {
            const wrapper = document.getElementById("forms-wrapper");
            if (!wrapper) return;
            wrapper.innerHTML = "";
            formIndex = 0;
        }

        function applyImportedPrefills(prefills, mode = "append") {
            if (!Array.isArray(prefills) || prefills.length === 0) return;

            if (mode === "replace") {
                _clearAllFormInstances();
            }

            prefills.forEach(p => cloneAndInitializeForm(p));

            const forms = getFormsArray();
            if (forms.length > 0) setActiveForm(forms[0].id);
            updateTOC();
        }
    </script>

    <!-- Add-on: 單一按鈕「輸出成網頁表格」＝輸出整頁網頁（含資料），且匯出檔案移除「匯入表格」區塊 -->
    



<script>
(function(){
  "use strict";
  const payloads = [{"商品":"香草可樂風味雲餡泡芙","會議日期":"2026-02-05","上市日":"2026-03-17","品類":"甜點","階段":"架上品","主事廠":"屏榮大溪","副事廠":"晉欣","提出者":"","類型":"","詳細類型":"","責任廠":"","責任端":"","記錄者":"","項目說明":"","執行說明":"","照片數量":"1","照片資料":"","備註":"","不採用原因(優化)":""},{"商品":"起司舒芙蕾布丁(舊檔重開)","會議日期":"2026-02-05","上市日":"2027-01-28","品類":"甜點","階段":"試產二","主事廠":"屏榮大溪","副事廠":"晉欣","提出者":"","類型":"","詳細類型":"","責任廠":"","責任端":"","記錄者":"","項目說明":"","執行說明":"","照片數量":"1","照片資料":"","備註":"","不採用原因(優化)":""},{"商品":"香菜蝦蝦捲","會議日期":"2026-02-05","上市日":"2026-03-04","品類":"沙拉","階段":"架上品","主事廠":"屏榮大溪","副事廠":"晉欣","提出者":"","類型":"","詳細類型":"","責任廠":"","責任端":"","記錄者":"","項目說明":"","執行說明":"","照片數量":"1","照片資料":"","備註":"","不採用原因(優化)":""},{"商品":"冰烤地瓜沙拉","會議日期":"2026-02-05","上市日":"2026-03-18","品類":"沙拉","階段":"試產一","主事廠":"晉欣","副事廠":"屏榮大溪","提出者":"","類型":"","詳細類型":"","責任廠":"","責任端":"","記錄者":"","項目說明":"","執行說明":"","照片數量":"1","照片資料":"","備註":"","不採用原因(優化)":""},{"商品":"溏心蛋洋芋沙拉","會議日期":"2026-02-05","上市日":"2027-01-22","品類":"沙拉","階段":"試產一","主事廠":"晉欣","副事廠":"屏榮新豐","提出者":"","類型":"","詳細類型":"","責任廠":"","責任端":"","記錄者":"","項目說明":"","執行說明":"","照片數量":"1","照片資料":"","備註":"","不採用原因(優化)":""},{"商品":"黃金地瓜菜菜捲","會議日期":"2026-02-05","上市日":"2027-01-23","品類":"沙拉","階段":"試產一","主事廠":"屏榮新豐","副事廠":"晉欣","提出者":"","類型":"","詳細類型":"","責任廠":"","責任端":"","記錄者":"","項目說明":"","執行說明":"","照片數量":"1","照片資料":"","備註":"","不採用原因(優化)":""}];

  function setByName(form, name, value){
    const els = form.querySelectorAll('[name="'+CSS.escape(name)+'"]');
    if(!els || els.length===0) return;

    if(els.length>1 && els[0].type && String(els[0].type).toLowerCase()==="radio"){
      els.forEach(el=>{ el.checked = (String(el.value??"")===String(value??"")); });
      return;
    }

    const el = els[0];
    const tag = (el.tagName||"").toLowerCase();
    const type = (el.type||"").toLowerCase();

    if(tag==="input" && type==="checkbox"){
      el.checked = !!value && String(value).trim()!=="" && String(value)!=="0";
      return;
    }

    el.value = String(value ?? "");
  }

  function trigger(form, name){
    const el = form.querySelector('[name="'+CSS.escape(name)+'"]');
    if(el){
      el.dispatchEvent(new Event('change', { bubbles:true }));
      el.dispatchEvent(new Event('input', { bubbles:true }));
    }
  }

  function applyPhotoPreview(form){
    const hidden = form.querySelector('input[name="照片資料"]');
    if(!hidden) return;
    const dataUrl = String(hidden.value || "");
    const img = form.querySelector('img[id^="issue_photo_preview-"]');
    const empty = form.querySelector('div[id^="issue_photo_empty-"]');
    if(!img || !empty) return;
    if(dataUrl && dataUrl.startsWith("data:image/")){
      img.src = dataUrl;
      img.classList.remove("hidden");
      empty.classList.add("hidden");
    }else{
      img.src = "";
      img.classList.add("hidden");
      empty.classList.remove("hidden");
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const forms = Array.from(document.querySelectorAll('.tracking-form-instance'));
    forms.forEach((form, i)=>{
      const p = payloads[i] || {};
      if(p["類型"]!==undefined){ setByName(form,"類型",p["類型"]); trigger(form,"類型"); }
      if(p["詳細類型"]!==undefined){ setByName(form,"詳細類型",p["詳細類型"]); trigger(form,"詳細類型"); }
      Object.keys(p).forEach((k)=>{
        if(k==="類型"||k==="詳細類型") return;
        setByName(form,k,p[k]);
      });
      trigger(form,"品類");
      trigger(form,"階段");
      trigger(form,"主事廠");
      trigger(form,"副事廠");
      applyPhotoPreview(form);
    });
  });
})();
</script>
</body>
</html>
