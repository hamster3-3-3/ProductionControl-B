<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>製管會項目填寫表單 (含PPT下載)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 PptxGenJS 用於生成簡報 -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* 淺灰背景 */
        }
        /* 統一輸入框的視覺風格 */
        .form-input {
            /* 保持 w-full 佔滿父容器寬度 */
            @apply w-full border border-gray-300 rounded-lg p-3
                   focus:ring-2 focus:ring-teal-500 focus:border-teal-500
                   transition duration-150;
        }
        /* 隱藏但保持佈局空間的樣式 */
        .hidden-collapse {
            display: none;
        }
        /* 用於複製的模板表單，隱藏不顯示 */
        .form-template {
            display: none;
        }

        /* 分頁顯示：一次只顯示一筆表單 */
        .form-page {
            display: none;
        }
        .form-page.is-active {
            display: block;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf',
                            500: '#14b8a6', 600: '#0d9488', 700: '#047876', 800: '#065f60', 900: '#004d40',
                        },
                        indigo: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8',
                            500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81',
                        },
                        red: {
                            100: '#fee2e2', 700: '#b91c1c', 200: '#fecaca', 400: '#f87171'
                        },
                        orange: {
                            500: '#f97316', 600: '#ea580c', 700: '#c2410c'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <!-- ============ Mobile: 左上角「試產目錄」按鈕 + 抽屜式目錄（避免蓋住表單） ============ -->
    <div class="lg:hidden fixed top-4 left-4 z-50">
        <button type="button" id="mobile-toc-open-btn"
            class="flex items-center gap-2 px-4 py-2 bg-white text-teal-700 font-semibold rounded-xl shadow-lg border border-gray-200 hover:bg-teal-50 focus:ring-4 focus:ring-teal-200">
            <span class="inline-block w-2 h-2 rounded-full bg-teal-500"></span>
            試產目錄
        </button>
    </div>

    <!-- 背景遮罩 -->
    <div id="mobile-toc-backdrop" class="hidden lg:hidden fixed inset-0 z-40 bg-black/40"></div>

    <!-- 左側抽屜 -->
    <aside id="mobile-toc-drawer"
        class="lg:hidden fixed inset-y-0 left-0 z-50 w-80 max-w-[85vw] bg-white shadow-2xl border-r border-gray-200 transform -translate-x-full transition-transform duration-200 flex flex-col">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
            <h2 class="text-lg font-extrabold text-teal-700">試產目錄</h2>
            <button type="button" id="mobile-toc-close-btn"
                class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold">
                關閉
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <div id="toc-container-mobile" class="space-y-2">
                <p class="text-sm text-gray-400">點擊商品名稱快速跳轉...</p>
            </div>
        </div>
    </aside>

    <!-- NEW: Responsive Wrapper -->
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6 pt-16 lg:pt-0">

        <!-- Desktop: Sidebar -->
        <div class="hidden lg:block w-72 flex-shrink-0">
            <div class="sticky top-8 p-4 bg-white rounded-xl shadow-xl border border-gray-200 max-h-[85vh] overflow-y-auto">
                <h2 class="text-xl font-bold text-teal-600 border-b-2 border-teal-100 pb-2 mb-3">試產目錄</h2>
                <div id="toc-container-desktop" class="space-y-2">
                    <p class="text-sm text-gray-400">點擊商品名稱快速跳轉...</p>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="flex-grow">
            <div id="main-container" class="bg-white rounded-xl shadow-2xl">
                <div class="p-6 rounded-t-xl bg-gray-50 border-b border-gray-200">
                    <h1 class="text-3xl font-extrabold text-gray-800">製管會項目</h1>
                    <p class="text-gray-500 mt-1">請填寫試產相關資訊及異常/優化追蹤細節。**所有欄位皆為非必填**</p>

                    <!-- NEW: 分頁導覽（一次顯示一筆表單） -->
                    <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex items-center gap-2">
                            <button type="button" id="prev-form-btn"
                                class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-semibold shadow-sm hover:bg-gray-50 focus:ring-4 focus:ring-teal-200 disabled:opacity-40 disabled:cursor-not-allowed">
                                上一筆
                            </button>
                            <button type="button" id="next-form-btn"
                                class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-semibold shadow-sm hover:bg-gray-50 focus:ring-4 focus:ring-teal-200 disabled:opacity-40 disabled:cursor-not-allowed">
                                下一筆
                            </button>
                            <span id="pager-indicator" class="ml-2 text-sm text-gray-500">目前：0 / 0</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            透過左側「試產目錄」點擊項目即可直接切換到該筆表單。
                        </div>
                    </div>
                </div>

                <div id="forms-wrapper" class="divide-y divide-gray-200">
                    <!-- 表單將在此生成 -->
                </div>

                <!-- Master Action Buttons -->
                <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-6 p-6 bg-gray-50 rounded-b-xl border-t border-gray-200">
                    <button type="button" id="submit-all-btn"
                            class="w-full md:w-auto px-8 py-3 bg-teal-600 text-white font-bold rounded-xl shadow-lg hover:bg-teal-700
                                    transition duration-300 transform hover:scale-105 focus:ring-4 focus:ring-teal-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        下載 CSV 報表
                    </button>
                    
                    <!-- 新增：下載 PPT 按鈕 -->
                    <button type="button" id="download-ppt-btn"
                            class="w-full md:w-auto px-8 py-3 bg-orange-600 text-white font-bold rounded-xl shadow-lg hover:bg-orange-700
                                    transition duration-300 transform hover:scale-105 focus:ring-4 focus:ring-orange-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                        下載簡報 (PPTX)
                    </button>
                </div>

                <!-- 輸出結果區塊 -->
                <div id="output-section" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2 px-6">CSV/Excel 輸出內容 (共 <span id="form-count-output">0</span> 筆)</h2>
                    <pre id="form-output" class="bg-gray-800 text-green-300 p-6 rounded-xl shadow-inner overflow-x-auto text-sm mx-6"></pre>
                    <p class="text-xs text-gray-500 mt-2 px-6">CSV 檔案已自動下載。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 表單模板 -->
    <form id="form-template" class="form-template">
        <div class="py-8 border-l-4 border-indigo-500 bg-indigo-50/50">
            <h2 class="form-title text-2xl font-extrabold text-indigo-700 mb-6 flex items-center pb-2 border-b border-indigo-200 px-6">
                <span class="inline-block w-2 h-6 bg-indigo-500 rounded-sm mr-3"></span>
                試產資訊 #1
            </h2>
            <div class="mb-6 px-6">
                <label for="item_name" class="block text-sm font-semibold text-gray-700 mb-1">商品名稱</label>
                <input type="text" id="item_name" name="商品" placeholder="請輸入完整的商品名稱" class="form-input focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 px-6">
                <div>
                    <label for="meeting_date" class="block text-sm font-semibold text-gray-700 mb-1">會議日期</label>
                    <input type="date" id="meeting_date" name="會議日期" class="form-input focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="launch_date" class="block text-sm font-semibold text-gray-700 mb-1">上市日</label>
                    <input type="date" id="launch_date" name="上市日" class="form-input focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="category" class="block text-sm font-semibold text-gray-700 mb-1">品類</label>
                    <select id="category" name="品類" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label for="phase" class="block text-sm font-semibold text-gray-700 mb-1">階段</label>
                    <select id="phase" name="階段" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label for="main_factory" class="block text-sm font-semibold text-gray-700 mb-1">主事廠</label>
                    <select id="main_factory" name="主事廠" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label for="sub_factory" class="block text-sm font-semibold text-gray-700 mb-1">副事廠</label>
                    <select id="sub_factory" name="副事廠" class="form-input bg-white focus:ring-indigo-500 focus:border-indigo-500"><option value="">(無)</option></select>
                </div>
            </div>
        </div>

        <div class="py-8 border-l-4 border-teal-500 bg-teal-50/50 border-t border-gray-200">
            <h2 class="text-2xl font-extrabold text-teal-700 mb-6 flex items-center pb-2 border-b border-teal-200 px-6">
                <span class="inline-block w-2 h-6 bg-teal-500 rounded-sm mr-3"></span>
                異常/優化追蹤
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 px-6 mb-6">
                <div>
                    <label for="proposer" class="block text-sm font-semibold text-gray-700 mb-1">提出者</label>
                    <input type="text" id="proposer" name="提出者" placeholder="請輸入提出者名稱" class="form-input focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="issue_type" class="block text-sm font-semibold text-gray-700 mb-1">類型</label>
                    <select id="issue_type" name="類型" class="form-input bg-white"></select>
                </div>
                <div id="detailed-type-container">
                    <label for="detailed_type" class="block text-sm font-semibold text-gray-700 mb-1">詳細類型</label>
                    <select id="detailed_type" name="詳細類型" class="form-input bg-white"><option value="">(請先選擇類型)</option></select>
                </div>
                <div id="responsible-factory-container" class="hidden-collapse">
                    <label for="responsible_factory" class="block text-sm font-semibold text-gray-700 mb-1">責任廠</label>
                    <select id="responsible_factory" name="責任廠" class="form-input bg-white"><option value="">(無)</option></select>
                </div>
                <div id="responsible-party-container" class="hidden-collapse">
                    <label for="responsible_party" class="block text-sm font-semibold text-gray-700 mb-1">責任端</label>
                    <select id="responsible_party" name="責任端" class="form-input bg-white"><option value="">(無)</option></select>
                </div>
                <div>
                    <label for="recorder" class="block text-sm font-semibold text-gray-700 mb-1">記錄者</label>
                    <input type="text" id="recorder" name="記錄者" placeholder="請輸入記錄者名稱" class="form-input focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="px-6 mt-2 space-y-4">
                <div>
                    <label for="item_description" class="block text-sm font-semibold text-gray-700 mb-1">項目說明</label>
                    <textarea id="item_description" name="項目說明" rows="6"
                        placeholder="請描述本次試產／架上品的異常狀況、優化重點或新增規範內容。"
                        class="form-input h-36 md:h-40 resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>
                <div>
                    <label for="execution_instructions" class="block text-sm font-semibold text-gray-700 mb-1">執行說明</label>
                    <textarea id="execution_instructions" name="執行說明" rows="6"
                        placeholder="請填寫後續處理方式、修正作法、試產調整方向。"
                        class="form-input h-36 md:h-40 resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>

                <!-- NEW: 照片上傳（手機可拍照/選圖；將會帶入PPT內容頁） -->
                <div>
                    <label for="issue_photo" class="block text-sm font-semibold text-gray-700 mb-1">照片上傳（異常/優化佐證）</label>
                    <input type="file" id="issue_photo" name="照片檔" accept="image/*"
                        class="form-input bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100" />
                    <input type="hidden" id="issue_photo_data" name="照片資料" value="" />
                    <div class="mt-3">
                        <div class="text-xs text-gray-500 mb-2">建議：拍攝/上傳後會自動壓縮（加速PPT生成、避免檔案過大）。</div>
                        <div class="w-full border border-gray-200 rounded-xl bg-white p-3">
                            <img id="issue_photo_preview" alt="照片預覽" class="hidden w-full max-h-64 object-contain rounded-lg" />
                            <div id="issue_photo_empty" class="text-sm text-gray-400">尚未上傳照片</div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="remarks" class="block text-sm font-semibold text-gray-700 mb-1">備註</label>
                    <textarea id="remarks" name="備註" rows="5"
                        placeholder="補充說明其他未涵蓋事項。"
                        class="form-input h-32 md:h-36 resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>
            </div>

            <div id="non-adoption-container" class="px-6 mt-6 hidden-collapse">
                <label for="reason_for_non_adoption" class="block text-sm font-semibold text-gray-700 mb-1">不採用原因(優化)</label>
                <textarea id="reason_for_non_adoption" name="不採用原因(優化)" rows="4" placeholder="請填寫不採納此優化提案的具體原因。"
                    class="form-input resize-y focus:ring-teal-500 focus:border-teal-500"></textarea>
            </div>
        </div>

        <div class="flex justify-end space-x-4 p-6 bg-gray-50 border-t border-gray-200">
            <button type="button" class="add-form-btn-local px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 focus:ring-4 focus:ring-indigo-300">新增一筆項目</button>
            <button type="button" class="remove-form-btn px-6 py-2 bg-red-100 text-red-700 font-semibold rounded-lg shadow-md hover:bg-red-200 transition duration-300 focus:ring-4 focus:ring-red-400">移除當前項目</button>
        </div>
    </form>

    <script>
        let formIndex = 0;
        const dropdownOptions = {
            '品類': ['飯糰', '壽司手卷', '主食', '便當', '熱食義麵', '季節調理麵', '沙拉', '小吃', '三明治(調理麵包)', '甜點'],
            '階段': ['架上品', '試產一', '試產二', '試產1-0', '試產1-1', '其他量化'],
            '工廠列表': ['屏榮新豐', '屏榮大溪', '晉欣', '長家', '玉美', '連合發'],
            '責任端': ['生產端', '開發端', '物料端'],
            '類型': ['異常', '優化提案', '優化採用', '新增規範'],
        };
        const detailedOptionsMap = {
            '異常': ['良品設定未完善', '不符合指示書設定', '微波狀態不符合設定', '物料未到樣', '賣相不符合指示書設定', '物料異常'],
            '優化提案': ['效率優化', '製程優化', '其他優化'],
            '優化採用': ['效率優化', '製程優化', '其他優化'],
            '新增規範': [], '': []
        };
        const preloadedData = [
            { meeting_date: '2025-12-24', category: '三明治(調理麵包)', item_name: '花生培根歐姆蛋堡', phase: '架上品', launch_date: '2025-12-24' },
            { meeting_date: '2025-12-24', category: '甜點', item_name: '生巧風味餅乾夾心', phase: '架上品', launch_date: '2025-12-24' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '溏心蛋洋芋沙拉', phase: '架上品', launch_date: '2025-12-17' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '玉美墨西哥風若醬起司嫩蛋捲', phase: '架上品', launch_date: '2025-12-17' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '青檸烤雞握沙拉(調整醬汁塗抹方式)', phase: '試產二' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '凱薩沙拉(封膜切換+延長效期)', phase: '試產二' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '元氣滿滿野蔬沙拉(封膜切換+延長效期)', phase: '試產二' },

            /* === 新增品項（2025/12/24 會議） === */
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '海藻野菜沙拉(沙拉醬包註解修正)', phase: '試產二' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '歐式田園沙拉(沙拉醬包註解修正)', phase: '試產二' },
            { meeting_date: '2025-12-24', category: '沙拉', item_name: '洋芋沙拉(試產2 確認立袋封膜)', phase: '試產二', launch_date: '2025-12-31' },
            { meeting_date: '2025-12-24', category: '小吃', item_name: '阿甘剝皮辣椒蒸蛋', phase: '架上品' }
        ];

        const outputHeaders = [
            { outputName: '會議日期', formName: '會議日期' },
            { outputName: '月', formName: '會議日期', type: 'month_derived' },
            { outputName: '品類', formName: '品類' },
            { outputName: '商品', formName: '商品' },
            { outputName: '階段', formName: '階段' },
            { outputName: '上市日', formName: '上市日', isOptional: true },
            { outputName: '主事廠', formName: '主事廠' },
            { outputName: '副事廠', formName: '副事廠', isOptional: true },
            { outputName: '提出者', formName: '提出者' },
            { outputName: '類型', formName: '類型' },
            { outputName: '詳細類型', formName: '詳細類型' },
            { outputName: '項目說明', formName: '項目說明' },
            { outputName: '執行說明', formName: '執行說明' },
            { outputName: '責任廠 (異常)', formName: '責任廠', isConditional: true, conditionValue: '異常' },
            { outputName: '責任端(異常)', formName: '責任端', isConditional: true, conditionValue: '異常' },
            { outputName: '不採用原因(優化)', formName: '不採用原因(優化)', isConditional: true, conditionValue: '優化提案', isOptional: true },
            { outputName: '備註', formName: '備註', isOptional: true },
            { outputName: '記錄者', formName: '記錄者' }
        ];

        function populateSelect(selectElement, options, defaultText = "(請選擇)") {
            if (!selectElement) return;
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = defaultText;
            selectElement.appendChild(defaultOption);
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }

        // --- Image Upload & Compression (store as DataURL for PPT) ---
        async function downscaleToJpegDataUrl(file, maxSide = 1280, quality = 0.82) {
            const readAsDataURL = (f) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = reject;
                reader.readAsDataURL(f);
            });

            const srcDataUrl = await readAsDataURL(file);

            try {
                const img = new Image();
                img.decoding = 'async';
                img.src = srcDataUrl;
                await new Promise((res, rej) => {
                    img.onload = () => res();
                    img.onerror = rej;
                });

                const w = img.naturalWidth || img.width;
                const h = img.naturalHeight || img.height;
                if (!w || !h) return srcDataUrl;

                const scale = Math.min(1, maxSide / Math.max(w, h));
                const targetW = Math.max(1, Math.round(w * scale));
                const targetH = Math.max(1, Math.round(h * scale));

                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');
                if (!ctx) return srcDataUrl;

                ctx.drawImage(img, 0, 0, targetW, targetH);
                const out = canvas.toDataURL('image/jpeg', quality);
                return out || srcDataUrl;
            } catch (e) {
                return srcDataUrl;
            }
        }

        async function handleIssuePhotoChange(formElement, index) {
            const suffix = `-${index}`;
            const fileInput = formElement.querySelector(`#issue_photo${suffix}`);
            const hiddenInput = formElement.querySelector(`#issue_photo_data${suffix}`);
            const previewImg = formElement.querySelector(`#issue_photo_preview${suffix}`);
            const emptyHint = formElement.querySelector(`#issue_photo_empty${suffix}`);

            if (!fileInput || !hiddenInput || !previewImg || !emptyHint) return;
            const file = fileInput.files && fileInput.files[0];

            if (!file) {
                hiddenInput.value = '';
                previewImg.src = '';
                previewImg.classList.add('hidden');
                emptyHint.classList.remove('hidden');
                return;
            }

            if (!file.type || !file.type.startsWith('image/')) {
                alert('請上傳圖片檔（image/*）。');
                fileInput.value = '';
                return;
            }

            const dataUrl = await downscaleToJpegDataUrl(file, 1280, 0.82);
            hiddenInput.value = dataUrl;

            previewImg.src = dataUrl;
            previewImg.classList.remove('hidden');
            emptyHint.classList.add('hidden');
        }

        // --- PPT Generation Logic ---
        function generatePPT() {
            let pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';

            // 取得會議日期 (從第一筆表單抓取，如果沒有則預設)
            const firstForm = document.querySelector('.tracking-form-instance');
            let meetingDate = "YYYY/MM/DD";
            if (firstForm) {
                const dateInput = firstForm.querySelector('input[name="會議日期"]');
                if (dateInput && dateInput.value) {
                    meetingDate = dateInput.value.replace(/-/g, '/');
                }
            }

            // --- 頁面 1: 封面 (Cover) ---
            let slide1 = pptx.addSlide();
            
            // 背景裝飾 (簡單的色塊模擬)
            slide1.addShape(pptx.shapes.RECTANGLE, { x: 0, y: 0, w: '100%', h: '100%', fill: 'F3F4F6' });
            slide1.addShape(pptx.shapes.RECTANGLE, { x: 0.5, y: 0.5, w: 9, h: 4.5, fill: 'FFFFFF', line: { color: 'CCCCCC', width: 1 } });

            // 封面文字內容
            slide1.addText("案別", { x: 0.8, y: 0.8, fontSize: 14, color: '666666' });
            slide1.addText("報告案", { x: 0.8, y: 1.2, fontSize: 24, bold: true, color: '000000' });
            
            slide1.addText("會議名稱", { x: 0.8, y: 2.0, fontSize: 14, color: '666666' });
            slide1.addText("製管會議", { x: 0.8, y: 2.4, fontSize: 20, bold: true, color: '000000' });

            slide1.addText("會議日期", { x: 0.8, y: 3.2, fontSize: 14, color: '666666' });
            slide1.addText(meetingDate, { x: 0.8, y: 3.6, fontSize: 20, bold: true, color: 'E91E63' });

            // 右側資訊 (報告人、機密等級等)
            let rightX = 6;
            slide1.addText("報告人: 食品研究所", { x: rightX, y: 0.8, fontSize: 14 });
            slide1.addText("機密等級: ■機密 □極機密", { x: rightX, y: 1.3, fontSize: 14 });
            slide1.addText("保密年限: ■ 5年 □10年 □永久", { x: rightX, y: 1.8, fontSize: 14 });
            slide1.addText("保存年限: ■10年 □20年 □永久", { x: rightX, y: 2.3, fontSize: 14 });

            // --- 頁面 2: 大綱 (Agenda) ---
            let slide2 = pptx.addSlide();
            slide2.addText("大綱", { x: 0.5, y: 0.5, fontSize: 28, bold: true, color: '004D40' });
            
            // 表格資料
            let rows = [
                [{ text: "重點摘要", options: { fill: "009688", color: "FFFFFF", bold: true, align: "center" } }, { text: "頁次", options: { fill: "009688", color: "FFFFFF", bold: true, align: "center" } }],
                ["製管會前會-試產1-0\n次週生產商品指示書檢視-矯正及產線效率優化提案", { text: "1", align: "center" }],
                ["製管會前會-專案確認\n食研所相關專案會議確認", { text: "2", align: "center" }],
                ["製管會議-試產品檢視\n試產一、試產二狀況檢視及相關數據報告", { text: "3", align: "center" }],
                ["製管會議-良品點檢\n新上市兩週架上品點檢狀況報告", { text: "4", align: "center" }]
            ];
            
            slide2.addTable(rows, {
                x: 0.5, y: 1.2, w: 9,
                colW: [7, 2],
                border: { pt: 1, color: "CCCCCC" },
                fontSize: 16,
                rowH: 0.8
            });

            // --- 頁面 3+: 內容頁 (Content Slides) ---
            const forms = document.querySelectorAll('.tracking-form-instance');
            let hasContent = false;

            forms.forEach((form) => {
                const formData = new FormData(form);
                const itemName = formData.get('商品') || '';
                const phase = formData.get('階段') || '';
                const description = formData.get('項目說明') || '';
                const execution = formData.get('執行說明') || '';
                const issuePhotoData = formData.get('照片資料') || '';

                // 只要「項目說明」或「執行說明」有內容就產生投影片
                if (description.trim() !== '' || execution.trim() !== '') {
                    hasContent = true;
                    const slide = pptx.addSlide();

                    // ====== 版面：依你提供的樣式（上：標題／中：照片大框／下：說明框） ======
                    // 標題：參、 階段
                    slide.addText(`參、 ${phase}`, {
                        x: 0.5, y: 0.35, w: 9.5, h: 0.6,
                        fontSize: 36, bold: true, color: '000000', fontFace: 'Arial'
                    });

                    // 照片區（大框）
                    const photoBox = { x: 0.5, y: 1.05, w: 9.5, h: 3.25 };
                    slide.addText('照片(上傳的圖片)', {
                        x: photoBox.x, y: photoBox.y - 0.28, w: photoBox.w, h: 0.25,
                        fontSize: 16, color: '000000', fontFace: 'Arial'
                    });
                    slide.addShape(pptx.shapes.RECTANGLE, {
                        x: photoBox.x, y: photoBox.y, w: photoBox.w, h: photoBox.h,
                        fill: 'FFFFFF', line: { color: '7F7F7F', width: 1 }
                    });

                    const hasPhoto = (issuePhotoData && typeof issuePhotoData === 'string' && issuePhotoData.startsWith('data:image/'));
                    if (hasPhoto) {
                        // 以「contain」方式放入，避免裁切
                        slide.addImage({
                            data: issuePhotoData,
                            x: photoBox.x + 0.05,
                            y: photoBox.y + 0.05,
                            w: photoBox.w - 0.10,
                            h: photoBox.h - 0.10,
                            sizing: { type: 'contain' }
                        });
                    }

                    // 說明區（下方小框）
                    const descBox = { x: 0.5, y: 4.45, w: 9.5, h: 1.05 };
                    slide.addShape(pptx.shapes.RECTANGLE, {
                        x: descBox.x, y: descBox.y, w: descBox.w, h: descBox.h,
                        fill: 'FFFFFF', line: { color: '7F7F7F', width: 1 }
                    });

                    let contentText = '說明：\n';
                    if (description) contentText += `${description}\n`;
                    if (execution) contentText += `${execution}`;

                    slide.addText(contentText, {
                        x: descBox.x + 0.15, y: descBox.y + 0.12,
                        w: descBox.w - 0.3, h: descBox.h - 0.24,
                        fontSize: 20, color: '000000', valign: 'top', fontFace: 'Arial'
                    });
                }
            });

            if (!hasContent) {
                alert("目前沒有任何表單填寫了「項目說明」或「執行說明」，因此未生成內容投影片。");
            }

            pptx.writeFile({ fileName: `製管會報告_${meetingDate.replace(/\//g, '')}.pptx` });
        }

        function openMobileTOC() { const drawer = document.getElementById('mobile-toc-drawer'); const backdrop = document.getElementById('mobile-toc-backdrop'); if (!drawer || !backdrop) return; backdrop.classList.remove('hidden'); drawer.classList.remove('-translate-x-full'); document.body.classList.add('overflow-hidden'); }
        function closeMobileTOC() { const drawer = document.getElementById('mobile-toc-drawer'); const backdrop = document.getElementById('mobile-toc-backdrop'); if (!drawer || !backdrop) return; drawer.classList.add('-translate-x-full'); backdrop.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }
        function cleanItemName(name) { return name.replace(/[\(（].*?[\)）]/g, '').trim(); }
        function renderTOCInto(containerEl, forms) {
            if (!containerEl) return;
            containerEl.innerHTML = '';
            if (forms.length === 0) { containerEl.innerHTML = '<p class="text-sm text-gray-400">尚無項目可供追蹤。</p>'; return; }
            forms.forEach((form, index) => {
                const suffix = form.id.split('-').pop();
                const itemInput = form.querySelector(`#item_name-${suffix}`);
                const rawItemName = itemInput ? itemInput.value : '';
                const cleanedName = cleanItemName(rawItemName) || `(項目 #${index + 1}: 待填寫)`;
                const targetId = form.id;
                const link = document.createElement('a');
                link.href = `#${targetId}`;
                link.textContent = cleanedName;
                link.className = 'block cursor-pointer p-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition duration-150 truncate';
                link.title = rawItemName;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    setActiveForm(targetId);
                    closeMobileTOC();
                });
                containerEl.appendChild(link);
            });
        }
        function updateTOC() {
            const forms = Array.from(document.querySelectorAll('.tracking-form-instance'));
            renderTOCInto(document.getElementById('toc-container-desktop'), forms);
            renderTOCInto(document.getElementById('toc-container-mobile'), forms);
            updatePagerUI();
        }
        function updateDetailedType(formElement, index) { const issueTypeSelect = formElement.querySelector(`#issue_type-${index}`); if (!issueTypeSelect) return; const detailedTypeContainer = formElement.querySelector(`#detailed-type-container-${index}`); const detailedTypeSelect = formElement.querySelector(`#detailed_type-${index}`); const selectedType = issueTypeSelect.value; const requiredDisplay = (selectedType in detailedOptionsMap && detailedOptionsMap[selectedType].length > 0); if (requiredDisplay) { detailedTypeContainer.classList.remove('hidden-collapse'); detailedTypeSelect.required = false; populateSelect(detailedTypeSelect, detailedOptionsMap[selectedType], "(請選擇詳細類型)"); } else { detailedTypeContainer.classList.add('hidden-collapse'); detailedTypeSelect.required = false; detailedTypeSelect.value = ''; } }
        function updateConditionalFields(formElement, index) { const issueTypeSelect = formElement.querySelector(`#issue_type-${index}`); if (!issueTypeSelect) return; const selectedType = issueTypeSelect.value; const isException = selectedType === '異常'; const isOptimizationProposal = selectedType === '優化提案'; const respFactoryContainer = formElement.querySelector(`#responsible-factory-container-${index}`); const respPartyContainer = formElement.querySelector(`#responsible-party-container-${index}`); const respFactorySelect = formElement.querySelector(`#responsible_factory-${index}`); const respPartySelect = formElement.querySelector(`#responsible_party-${index}`); if (isException) { respFactoryContainer.classList.remove('hidden-collapse'); respPartyContainer.classList.remove('hidden-collapse'); respFactorySelect.required = false; respPartySelect.required = false; } else { respFactoryContainer.classList.add('hidden-collapse'); respPartyContainer.classList.add('hidden-collapse'); respFactorySelect.required = false; respPartySelect.required = false; respFactorySelect.value = ''; respPartySelect.value = ''; } const nonAdoptionContainer = formElement.querySelector(`#non-adoption-container-${index}`); const nonAdoptionTextarea = formElement.querySelector(`#reason_for_non_adoption-${index}`); if (isOptimizationProposal) { nonAdoptionContainer.classList.remove('hidden-collapse'); nonAdoptionTextarea.required = false; } else { nonAdoptionContainer.classList.add('hidden-collapse'); nonAdoptionTextarea.required = false; nonAdoptionTextarea.value = ''; } }
        function reIndexForms() { const forms = document.querySelectorAll('.tracking-form-instance'); forms.forEach((form, newIndex) => { const titleElement = form.querySelector('.form-title'); if (titleElement) { titleElement.textContent = `試產資訊 #${newIndex + 1}`; } }); }
        function removeFormInstance(formElement) {
            const wasActive = formElement.classList.contains('is-active');
            const allBefore = Array.from(document.querySelectorAll('.tracking-form-instance'));
            const removeIndex = allBefore.indexOf(formElement);

            formElement.remove();

            const forms = Array.from(document.querySelectorAll('.tracking-form-instance'));
            if (forms.length === 0) {
                cloneAndInitializeForm();
                return;
            }

            if (wasActive) {
                const nextCandidate = forms[Math.min(removeIndex, forms.length - 1)] || forms[0];
                setActiveForm(nextCandidate.id);
            }

            reIndexForms();
            updateTOC();
        }
        function initializeFormInstance(formElement, index, dataToPreFill = {}) {
            formElement.classList.add('form-page');
            formElement.id = `tracking-form-instance-${index}`;
            const titleElement = formElement.querySelector('.form-title');
            if (titleElement) titleElement.textContent = `試產資訊 #${document.querySelectorAll('.tracking-form-instance').length}`;
            const suffix = `-${index}`;
            formElement.querySelectorAll('[id], [for]').forEach(el => {
                if (el.id && !el.id.endsWith(suffix)) el.id += suffix;
                if (el.hasAttribute('for') && !el.getAttribute('for').endsWith(suffix)) el.setAttribute('for', el.getAttribute('for') + suffix);
            });
            const selectMap = {
                'category': { options: dropdownOptions['品類'], default: "(請選擇)" },
                'phase': { options: dropdownOptions['階段'], default: "(請選擇)" },
                'main_factory': { options: dropdownOptions['工廠列表'], default: "(請選擇)" },
                'sub_factory': { options: dropdownOptions['工廠列表'], default: "(無)" },
                'issue_type': { options: dropdownOptions['類型'], default: "(請選擇)" },
                'responsible_factory': { options: dropdownOptions['工廠列表'], default: "(無)" },
                'responsible_party': { options: dropdownOptions['責任端'], default: "(無)" }
            };
            Object.keys(selectMap).forEach(baseId => {
                const selectEl = formElement.querySelector(`#${baseId}${suffix}`);
                if (selectEl) populateSelect(selectEl, selectMap[baseId].options, selectMap[baseId].default);
            });
            if (dataToPreFill && Object.keys(dataToPreFill).length > 0) {
                const fields = { 'item_name': dataToPreFill.item_name, 'meeting_date': dataToPreFill.meeting_date, 'launch_date': dataToPreFill.launch_date, 'category': dataToPreFill.category, 'phase': dataToPreFill.phase, 'main_factory': dataToPreFill.main_factory, 'sub_factory': dataToPreFill.sub_factory || '' };
                for (const [key, value] of Object.entries(fields)) {
                    if (value) { const input = formElement.querySelector(`#${key}${suffix}`); if (input) input.value = value; }
                }
            }
            const issueTypeSelect = formElement.querySelector(`#issue_type${suffix}`);
            if (issueTypeSelect) {
                updateDetailedType(formElement, index); updateConditionalFields(formElement, index);
                issueTypeSelect.addEventListener('change', () => { updateDetailedType(formElement, index); updateConditionalFields(formElement, index); });
            }
            const itemNameInput = formElement.querySelector(`#item_name${suffix}`);
            if (itemNameInput) itemNameInput.addEventListener('input', updateTOC);
            const removeBtn = formElement.querySelector('.remove-form-btn');
            if (removeBtn) removeBtn.addEventListener('click', () => { removeFormInstance(formElement); });
            const addLocalBtn = formElement.querySelector('.add-form-btn-local');
            if (addLocalBtn) addLocalBtn.addEventListener('click', () => { cloneAndInitializeForm(); updateTOC(); });

            const photoInput = formElement.querySelector(`#issue_photo${suffix}`);
            if (photoInput) {
                photoInput.addEventListener('change', () => { handleIssuePhotoChange(formElement, index); });
            }
        }
        function cloneAndInitializeForm(dataToPreFill) {
            const templateForm = document.getElementById('form-template');
            const formsWrapper = document.getElementById('forms-wrapper');
            const newForm = templateForm.cloneNode(true);
            newForm.classList.remove('form-template');
            newForm.classList.add('tracking-form-instance');
            newForm.classList.add('form-page');

            const currentForms = document.querySelectorAll('.tracking-form-instance');
            formsWrapper.appendChild(newForm);

            const uniqueIndex = formIndex++;
            initializeFormInstance(newForm, uniqueIndex, dataToPreFill);

            setActiveForm(newForm.id);

            if (!dataToPreFill && currentForms.length > 0) {
                const main = document.getElementById('main-container');
                if (main) main.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            reIndexForms();
            updateTOC();
        }
        function convertToCSV(data) {
            if (data.length === 0) return '';
            const headerArray = outputHeaders.map(h => h.outputName);
            const csvHeader = headerArray.map(key => `"${key.replace(/"/g, '""')}"`).join(',');
            const csvRows = data.map(row => {
                return headerArray.map(header => {
                    let value = row[header] === undefined ? '' : String(row[header]);
                    value = value.replace(/\n/g, ' ').replace(/"/g, '""');
                    return `"${value}"`;
                }).join(',');
            }).join('\n');
            return csvHeader + '\n' + csvRows;
        }
        function downloadCSV(csvString, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        function handleSubmission() {
            const forms = document.querySelectorAll('.tracking-form-instance');
            const allFormData = [];
            if (forms.length === 0) {
                const outputSection = document.getElementById('output-section');
                outputSection.classList.add('hidden');
                downloadCSV(convertToCSV([]), `製管會項目數據_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.csv`);
                return;
            }
            forms.forEach((form) => {
                const data = {};
                const formData = new FormData(form);
                const issueType = formData.get('類型');
                outputHeaders.forEach(header => {
                    const formName = header.formName;
                    const outputName = header.outputName;
                    let value = "";
                    if (header.type === 'month_derived') {
                        const dateValue = formData.get('會議日期');
                        if (dateValue && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            const parts = dateValue.split('-');
                            const dateObj = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                            value = dateObj.getUTCMonth() + 1;
                        } else { value = ""; }
                    } else {
                        value = formData.get(formName) ? formData.get(formName).trim() : "";
                        if (header.isConditional) { if (issueType !== header.conditionValue) value = ""; }
                        if (value === "") value = "";
                    }
                    data[outputName] = value;
                });
                allFormData.push(data);
            });
            const outputSection = document.getElementById('output-section');
            const formOutput = document.getElementById('form-output');
            const formCountOutput = document.getElementById('form-count-output');
            const csvContent = convertToCSV(allFormData);
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            downloadCSV(csvContent, `製管會項目數據_${date}.csv`);
            formCountOutput.textContent = allFormData.length;
            formOutput.textContent = csvContent;
            outputSection.classList.remove('hidden');
            outputSection.scrollIntoView({ behavior: 'smooth' });
        }

        function getFormsArray() {
            return Array.from(document.querySelectorAll('.tracking-form-instance'));
        }

        function setActiveForm(targetId) {
            const forms = getFormsArray();
            if (forms.length === 0) return;

            const target = document.getElementById(targetId) || forms[0];
            forms.forEach(f => f.classList.remove('is-active'));
            target.classList.add('is-active');

            updatePagerUI();

            const main = document.getElementById('main-container');
            if (main) main.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updatePagerUI() {
            const forms = getFormsArray();
            const indicator = document.getElementById('pager-indicator');
            const prevBtn = document.getElementById('prev-form-btn');
            const nextBtn = document.getElementById('next-form-btn');

            if (!indicator || !prevBtn || !nextBtn) return;

            const activeIndex = Math.max(0, forms.findIndex(f => f.classList.contains('is-active')));
            const total = forms.length;
            const current = total === 0 ? 0 : activeIndex + 1;

            indicator.textContent = `目前：${current} / ${total}`;
            prevBtn.disabled = (total === 0 || activeIndex <= 0);
            nextBtn.disabled = (total === 0 || activeIndex >= total - 1);
        }

        function goPrevForm() {
            const forms = getFormsArray();
            if (forms.length === 0) return;
            const activeIndex = forms.findIndex(f => f.classList.contains('is-active'));
            const target = forms[Math.max(0, activeIndex - 1)] || forms[0];
            setActiveForm(target.id);
        }

        function goNextForm() {
            const forms = getFormsArray();
            if (forms.length === 0) return;
            const activeIndex = forms.findIndex(f => f.classList.contains('is-active'));
            const target = forms[Math.min(forms.length - 1, activeIndex + 1)] || forms[forms.length - 1];
            setActiveForm(target.id);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const openBtn = document.getElementById('mobile-toc-open-btn');
            const closeBtn = document.getElementById('mobile-toc-close-btn');
            const backdrop = document.getElementById('mobile-toc-backdrop');
            if (openBtn) openBtn.addEventListener('click', openMobileTOC);
            if (closeBtn) closeBtn.addEventListener('click', closeMobileTOC);
            if (backdrop) backdrop.addEventListener('click', closeMobileTOC);
            if (preloadedData && preloadedData.length > 0) {
                preloadedData.forEach(data => { cloneAndInitializeForm(data); });
            } else {
                cloneAndInitializeForm();
            }

            const forms = getFormsArray();
            if (forms.length > 0) {
                // 預設顯示第一筆，而不是最後一筆
                setActiveForm(forms[0].id);
            }

            updateTOC();

            const prevBtn = document.getElementById('prev-form-btn');
            const nextBtn = document.getElementById('next-form-btn');
            if (prevBtn) prevBtn.addEventListener('click', goPrevForm);
            if (nextBtn) nextBtn.addEventListener('click', goNextForm);
            document.getElementById('submit-all-btn').addEventListener('click', handleSubmission);
            
            const pptBtn = document.getElementById('download-ppt-btn');
            if(pptBtn) pptBtn.addEventListener('click', generatePPT);
        });
    </script>
</body>
</html>
